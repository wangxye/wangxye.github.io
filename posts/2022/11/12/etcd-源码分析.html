<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>etcd 源码分析 | Abyss</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/assets/img/favicon.ico">
    <meta name="description" content="Abyss&#39;s blog">
    <link rel="preload" href="/assets/js/vendor.vue.8c2dfada.js" as="script"><link rel="preload" href="/assets/css/1.styles.6d048c9e.css" as="style"><link rel="preload" href="/assets/js/vendor.commons.6d048c9e.js" as="script"><link rel="preload" href="/assets/css/styles.33c1ef9e.css" as="style"><link rel="preload" href="/assets/js/app.33c1ef9e.js" as="script"><link rel="preload" href="/assets/css/8.styles.49c1931d.css" as="style"><link rel="preload" href="/assets/js/8.49c1931d.js" as="script"><link rel="preload" href="/assets/js/35.21e5fed2.js" as="script"><link rel="prefetch" href="/assets/css/0.styles.9d2a2822.css"><link rel="prefetch" href="/assets/css/4.styles.c6c31e98.css"><link rel="prefetch" href="/assets/css/5.styles.4eb26167.css"><link rel="prefetch" href="/assets/css/6.styles.b12328b4.css"><link rel="prefetch" href="/assets/css/7.styles.efe9eb71.css"><link rel="prefetch" href="/assets/js/0.9d2a2822.js"><link rel="prefetch" href="/assets/js/10.a9dc25e5.js"><link rel="prefetch" href="/assets/js/11.00369fa9.js"><link rel="prefetch" href="/assets/js/12.ea10e35f.js"><link rel="prefetch" href="/assets/js/13.a06eb5f4.js"><link rel="prefetch" href="/assets/js/14.b8261236.js"><link rel="prefetch" href="/assets/js/15.b9ace423.js"><link rel="prefetch" href="/assets/js/16.5a5b8cc5.js"><link rel="prefetch" href="/assets/js/17.17f2e0ee.js"><link rel="prefetch" href="/assets/js/18.51cabdfa.js"><link rel="prefetch" href="/assets/js/19.b793f115.js"><link rel="prefetch" href="/assets/js/20.88ebd830.js"><link rel="prefetch" href="/assets/js/21.1e063384.js"><link rel="prefetch" href="/assets/js/22.f2dc7b40.js"><link rel="prefetch" href="/assets/js/23.1debcb1d.js"><link rel="prefetch" href="/assets/js/24.bd3124d6.js"><link rel="prefetch" href="/assets/js/25.cededf34.js"><link rel="prefetch" href="/assets/js/26.ba33d80e.js"><link rel="prefetch" href="/assets/js/27.69b99307.js"><link rel="prefetch" href="/assets/js/28.3c591772.js"><link rel="prefetch" href="/assets/js/29.d53afd48.js"><link rel="prefetch" href="/assets/js/30.c3c2f0cc.js"><link rel="prefetch" href="/assets/js/31.8e5767fd.js"><link rel="prefetch" href="/assets/js/32.6963e79e.js"><link rel="prefetch" href="/assets/js/33.ae19a8db.js"><link rel="prefetch" href="/assets/js/34.c00ad780.js"><link rel="prefetch" href="/assets/js/36.c5ff7947.js"><link rel="prefetch" href="/assets/js/37.42d66982.js"><link rel="prefetch" href="/assets/js/4.c6c31e98.js"><link rel="prefetch" href="/assets/js/5.4eb26167.js"><link rel="prefetch" href="/assets/js/6.b12328b4.js"><link rel="prefetch" href="/assets/js/7.efe9eb71.js"><link rel="prefetch" href="/assets/js/9.4c13e2c6.js">
    <link rel="stylesheet" href="/assets/css/1.styles.6d048c9e.css"><link rel="stylesheet" href="/assets/css/styles.33c1ef9e.css"><link rel="stylesheet" href="/assets/css/8.styles.49c1931d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-meteorlxy"><header class="header" style="background-size:cover;background-repeat:no-repeat;background-position:center;background-attachment:scroll;background-image:url(/assets/img/header-image-02.jpg);" data-v-3054f967><div data-v-eab05d90 data-v-3054f967><nav class="navbar" data-v-eab05d90><div class="container" data-v-eab05d90><a href="/" class="router-link-active" data-v-eab05d90><span class="navbar-site-name" data-v-eab05d90>
          Abyss
        </span></a> <div class="navbar-toggler" data-v-eab05d90><svg class="icon" style="font-size:1.2em;" data-v-eab05d90 data-v-eab05d90><title data-v-eab05d90 data-v-eab05d90>menu</title><use xlink:href="#icon-menu" data-v-eab05d90 data-v-eab05d90></use></svg></div> <div class="navbar-links" data-v-eab05d90><a href="/" class="navbar-link" data-v-eab05d90>
            Home
          </a><a href="/posts/" class="navbar-link router-link-active" data-v-eab05d90>
            Posts
          </a><a href="/about/" class="navbar-link" data-v-eab05d90>
            About
          </a><a href="https://github.com/wangxye/wangxye.github.io" target="_blank" rel="noopener noreferrer" class="navbar-link" data-v-eab05d90><span data-v-eab05d90>Github</span> <span data-v-eab05d90><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div></div></nav> <div class="navbar-holder" style="display:none;" data-v-eab05d90></div></div> <div class="banner" data-v-66d98992 data-v-3054f967 data-v-3054f967><div class="container" data-v-66d98992><div class="center" data-v-66d98992><h1 data-v-66d98992 data-v-3054f967>
          etcd 源码分析
        </h1></div></div></div></header> <div class="container clearfix show-aside" data-v-41e4f7f8 data-v-41e4f7f8><main class="main" data-v-41e4f7f8><div class="post" data-v-41e4f7f8 data-v-41e4f7f8><section class="post-meta main-div" data-v-cae733bc><section class="post-date clearfix" data-v-cae733bc><span class="create-date" data-v-cae733bc>
        Created : 2022-11-12
      </span> <!----> <br data-v-cae733bc></section> <section class="post-links" data-v-cae733bc><a href="/posts/2022/04/06/mit6-824-2020-lab2a-leader-election-and-heartbeat.html" class="post-link" data-v-cae733bc>
        Previous Post : MIT6.824-2020 Lab2A Leader Election and heartbeat
      </a> <a href="/posts/2023/02/19/mvcc.html" class="post-link" data-v-cae733bc>
        Next Post : Mysql原理——多版本并发控制
      </a></section></section> <article class="main-div"><span id="busuanzi_container_page_pv">
		Page view : <span id="busuanzi_value_page_pv"></span></span> <div class="post-content content content__default"><h1 id="基于etcd的源码分析"><a href="#基于etcd的源码分析" class="header-anchor">#</a> 基于etcd的源码分析</h1> <h2 id="一、etcd概述"><a href="#一、etcd概述" class="header-anchor">#</a> 一、etcd概述</h2> <h3 id="_1-1-etcd是什么"><a href="#_1-1-etcd是什么" class="header-anchor">#</a> 1.1 etcd是什么</h3> <p>ectd是CoreOS公司发起的一个开源项目，是用于共享配置和服务发现的分布式，一致性的KV存储系统，它的目标是提供了一种可靠的方法来存储分布式系统或机器集群需要访问的数据。具有以下特点：</p> <p>(1) 简单：安装配置简单，且提供HTTP API进行交互，使用也简单；</p> <p>(2) 存储：将数据存储在分层组织的目录中，如同在标准文件系统中；</p> <p>(3) Watch机制：Watch 指定的键、前缀目录的更改，监测特定的键或目录的更改时机，并能对值的更改做出相应的反应；</p> <p>(4) 安全：支持 SSL 证书验证；</p> <p>(5) 快速：按照官网给出的数据, 在2CPU，1.8G内存，SSD磁盘这样的配置下，单节点的写性能可以达到16K QPS, 而先写后读也能达到12K QPS；</p> <p>(6) 一致可靠：基于 Raft 共识算法，实现分布式系统内部数据存储、服务调用的一致性和高可用性；</p> <p>(7) Revision 机制：每个 Key 带有一个 Revision 号，每进行一次事务便加一，因此它是全局唯一的，如初始值为 0，进行一次 Put 操作，Key 的 Revision 变为 1，同样的操作，再进行一次，Revision 变为 2；换成 Key1 进行 Put 操作，Revision 将变为 3。这种机制有一个作用，即通过 Revision 的大小就可知道写操作的顺序，这对于实现公平锁，队列十分有益；</p> <p>(8) Lease 机制：即租约机制(TTL，Time To Live)，Etcd 可以为存储的 Key-Value 对设置租约，当租约到期，Key-Value 将失效删除；同时也支持续约，通过客户端可以在租约到期之前续约，以避免 Key-Value 对过期失效；此外，还支持解约，一旦解约，与该租约绑定的 Key-Value 将失效删除；</p> <p><img src="/assets/img/etcd-1.png" alt="etcd-1"></p> <h3 id="_1-2-应用场景"><a href="#_1-2-应用场景" class="header-anchor">#</a> 1.2 应用场景</h3> <p>etcd 在稳定性、可靠性和可伸缩性上表现极佳，同时也为云原生应用系统提供了协调机制。etcd 经常用于服务注册与发现的场景，此外还有键值对存储、消息发布与订阅、分布式锁等场景。</p> <h4 id="_1-2-1-服务发现"><a href="#_1-2-1-服务发现" class="header-anchor">#</a> 1.2.1 服务发现</h4> <p>服务发现要解决的也是分布式系统中最常见的问题之一，即在同一个分布式集群中的进程或服务，要如何才能找到对方并建立连接。本质上来说，服务发现就是想要了解集群中是否有进程在监听 udp 或 tcp 端口，并且通过名字就可以查找和连接。要解决服务发现的问题，需要有下面三大支柱，缺一不可。</p> <p>(1) 一个强一致性、高可用的服务存储目录。基于 Raft 算法的etcd天生就是这样一个强一致性高可用的服务存储目录；</p> <p>(2) 一种注册服务和监控服务健康状态的机制。用户可以在etcd中注册服务，并且对注册的服务设置key TTL，定时保持服务的心跳以达到监控健康状态的效果。</p> <p>(3) 一种查找和连接服务的机制。通过在etcd指定的主题下注册的服务也能在对应的主题下查找到。为了确保连接，我们可以在每个服务机器上都部署一个 Proxy 模式的 etcd，这样就可以确保能访问etcd集群的服务都能互相连接。</p> <h4 id="_1-2-2-消息发布与订阅"><a href="#_1-2-2-消息发布与订阅" class="header-anchor">#</a> 1.2.2 消息发布与订阅</h4> <p>在分布式系统中，最适用的一种组件间通信方式就是消息发布与订阅。即构建一个配置共享中心，数据提供者在这个配置中心发布消息，而消息使用者则订阅他们关心的主题，一旦主题有消息发布，就会实时通知订阅者。通过这种方式可以做到分布式系统配置的集中式管理与动态更新。</p> <p>(1) 应用中用到的一些配置信息放到etcd上进行集中管理。应用在启动的时候主动从etcd获取一次配置信息，同时，在etcd节点上注册一个 Watcher 并等待，以后每次配置有更新的时候，etcd 都会实时通知订阅者，以此达到获取最新配置信息的目的；</p> <p>(2) 分布式搜索服务中，索引的元信息和服务器集群机器的节点状态存放在etcd中，供各个客户端订阅使用。etcd租约机制可以确保机器状态是实时更新的；</p> <p>(3) 分布式日志收集系统。这个系统的核心工作是收集分布在不同机器的日志。收集器通常是按照应用(或主题)来分配收集任务单元，因此可以在etcd上创建一个以应用(主题)命名的目录 P，并将这个应用(主题相关)的所有机器 ip，以子目录的形式存储到目录 P 上，然后设置一个etcd递归的 Watcher，递归式的监控应用(主题)目录下所有信息的变动，即这样就实现了机器 IP(消息)变动的时候，能够实时通知到收集器调整任务分配；</p> <p>(4) 系统中信息需要动态自动获取与人工干预修改信息请求内容的情况。通常是暴露出接口，例如 JMX 接口，来获取一些运行时的信息。引入etcd之后，就不用自己实现一套方案了，只要将这些信息存放到指定的etcd目录中即可，etcd 的这些目录就可以通过 HTTP 的接口在外部访问。</p> <h4 id="_1-2-3-服务均衡"><a href="#_1-2-3-服务均衡" class="header-anchor">#</a> 1.2.3 服务均衡</h4> <p>分布式系统中，为了保证服务的高可用以及数据的一致性，通常都会把数据和服务部署多份，以此达到对等服务，即使其中的某一个服务失效了，也不影响使用。由此带来的坏处是数据写入性能下降，而好处则是数据访问时的负载均衡。因为每个对等服务节点上都存有完整的数据，所以用户的访问流量就可以分流到不同的机器上。</p> <p>(1) etcd本身分布式架构存储的信息访问支持负载均衡。etcd 集群化以后，每个etcd的核心节点都可以处理用户的请求。</p> <p>(2) 利用etcd维护一个负载均衡节点表。etcd 可以监控一个集群中多个节点的状态，当有一个请求发过来后，可以轮询式的把请求转发给存活着的多个状态。</p> <h4 id="_1-2-4-分布式通知与协调"><a href="#_1-2-4-分布式通知与协调" class="header-anchor">#</a> 1.2.4 分布式通知与协调</h4> <p>分布式通知与协调与前面提到的消息发布和订阅有些相似，都用到了etcd中的 Watcher 机制，通过注册与异步通知机制，实现分布式环境下不同系统之间的通知与协调，从而对数据变更做到实时处理。</p> <p>实现方式通常是这样：不同系统都在etcd上对同一个目录进行注册，同时设置 Watcher 观测该目录的变化，当某个系统更新了etcd的目录，那么设置了 Watcher 的系统就会收到通知，并作出相应处理。</p> <p>(1) 通过etcd进行低耦合的心跳检测。检测系统和被检测系统通过etcd上某个目录关联而非直接关联起来，这样可以大大减少系统的耦合性。</p> <p>(2) 通过etcd完成系统调度。某系统有控制台和推送系统两部分组成，控制台的职责是控制推送系统进行相应的推送工作。管理人员在控制台作的一些操作，实际上是修改了etcd上某些目录节点的状态，而etcd就把这些变化通知给注册了 Watcher 的推送系统客户端，推送系统再作出相应的推送任务。</p> <p>(3) 通过etcd完成工作汇报。大部分类似的任务分发系统，子任务启动后，到etcd来注册一个临时工作目录，并且定时将自己的进度进行汇报，这样任务管理者就能够实时知道任务进度。</p> <h4 id="_1-2-5-分布式锁"><a href="#_1-2-5-分布式锁" class="header-anchor">#</a> 1.2.5 分布式锁</h4> <p>因为 etcd 使用 Raft 算法保持了数据的强一致性，某次操作存储到集群中的值必然是全局一致的，所以很容易实现分布式锁。锁服务有两种使用方式，一是保持独占，二是控制时序。</p> <p>(1) 保持独占即所有获取锁的用户最终只有一个可以得到。etcd 为此提供了一套实现分布式锁原子操作 CAS(CompareAndSwap)的 API。通过设置prevExist值，可以保证在多个节点同时去创建某个目录时，只有一个成功。而创建成功的用户就可以认为是获得了锁。</p> <p>(2) 控制时序，即所有想要获得锁的用户都会被安排执行，但是获得锁的顺序也是全局唯一的，同时决定了执行顺序。etcd 为此也提供了一套 API(自动创建有序键)，对一个目录建值时指定为POST动作，这样 etcd 会自动在目录下生成一个当前最大的值为键，存储这个新的值(客户端编号)。同时还可以使用 API 按顺序列出所有当前目录下的键值。此时这些键的值就是客户端的时序，而这些键中存储的值可以是代表客户端的编号。</p> <h4 id="_1-2-6-分布式队列"><a href="#_1-2-6-分布式队列" class="header-anchor">#</a> 1.2.6 分布式队列</h4> <p>分布式队列的常规用法与分布式锁的控制时序用法类似，即创建一个先进先出的队列，保证顺序。另一种比较有意思的实现是在保证队列达到某个条件时再统一按顺序执行。这种方法的实现可以在 /queue 这个目录中另外建立一个 /queue/condition 节点。</p> <p>(1) condition 可以表示队列大小。比如一个大的任务需要很多小任务就绪的情况下才能执行，每次有一个小任务就绪，就给这个 condition 数字加 1，直到达到大任务规定的数字，再开始执行队列里的一系列小任务，最终执行大任务。</p> <p>(2) condition 可以表示某个任务在不在队列。这个任务可以是所有排序任务的首个执行程序，也可以是拓扑结构中没有依赖的点。通常，必须执行这些任务后才能执行队列中的其他任务。</p> <p>(3) condition 还可以表示其它的一类开始执行任务的通知。可以由控制程序指定，当 condition 出现变化时，开始执行队列任务。</p> <h4 id="_1-2-7-集群监控与leader竞选"><a href="#_1-2-7-集群监控与leader竞选" class="header-anchor">#</a> 1.2.7 集群监控与Leader竞选</h4> <p>通过 etcd 来进行监控实现起来非常简单并且实时性强。例如，前面几个场景已经提到 Watcher 机制，当某个节点消失或有变动时，Watcher 会第一时间发现并告知用户。此外，节点可以设置TTL key，比如每隔 30s 发送一次心跳使代表该机器存活的节点继续存在，否则节点消失。这样就可以第一时间检测到各节点的健康状态，以完成集群的监控要求。</p> <p>另外，使用分布式锁，可以完成 Leader 竞选。这种场景通常是一些长时间 CPU 计算或者使用 IO 操作的机器，只需要竞选出的 Leader 计算或处理一次，就可以把结果复制给其他的 Follower。从而避免重复劳动，节省计算资源。</p> <p>这个的经典场景是搜索系统中建立全量索引。如果每个机器都进行一遍索引的建立，不但耗时而且建立索引的一致性不能保证。通过在 etcd 的 CAS 机制同时创建一个节点，创建成功的机器作为 Leader，进行索引计算，然后把计算结果分发到其它节点。</p> <h3 id="_1-3-常用术语"><a href="#_1-3-常用术语" class="header-anchor">#</a> 1.3 常用术语</h3> <p>为了有效提高读者阅读的效率，本小节将总结后续常出现的专用术语，先混个眼熟，后续具体实现过程会继续深入。</p> <table><thead><tr><th>术语</th> <th>描述</th> <th>备注</th></tr></thead> <tbody><tr><td>Raft</td> <td>Raft算法，etcd实现一致性的核心</td> <td>ectd-raft 模型</td></tr> <tr><td>Follower</td> <td>Raft中的从属节点</td> <td>竞争Leader失败</td></tr> <tr><td>Leader</td> <td>Raft中的领导节点，处理数据提交</td> <td>Leader协调集群</td></tr> <tr><td>Candidate</td> <td>候选节点</td> <td>当Follower接收Leader节点的消息超时会转变为Candidate</td></tr> <tr><td>Node</td> <td>Raft状态机的实例</td> <td>Raft中涉及多个节点</td></tr> <tr><td>Member</td> <td>etcd实例，管理对应Node节点</td> <td>可处理客户端请求</td></tr> <tr><td>Peer</td> <td>同一个集群中的另一个Member</td> <td>其他成员</td></tr> <tr><td>Cluster</td> <td>etcd集群</td> <td>拥有多个ectd Member</td></tr> <tr><td>Lease</td> <td>租期</td> <td>关键设置的租期，过期删除</td></tr> <tr><td>Watch</td> <td>监测机制</td> <td>监控键值对的变化</td></tr> <tr><td>Term</td> <td>任期</td> <td>某个节点成为Leader，  到下一次竞选的时间</td></tr> <tr><td>WAL</td> <td>预写式日志</td> <td>持久化存储的日志格式</td></tr> <tr><td>MVCC</td> <td>多版本并发控制</td> <td>事务隔离的手段</td></tr> <tr><td>revision</td> <td>MVCC中的版本</td> <td>每一次key-value操作都会有revision</td></tr> <tr><td>keyIndex</td> <td>Key的生命周期</td> <td>记录一个key的生命周期中所涉及过的版本</td></tr> <tr><td>Client</td> <td>客户端</td> <td>向etcd发起请求的客户端</td></tr></tbody></table> <h2 id="二、etcd组成模型"><a href="#二、etcd组成模型" class="header-anchor">#</a> 二、etcd组成模型</h2> <h3 id="_2-1-服务器状态"><a href="#_2-1-服务器状态" class="header-anchor">#</a> 2.1 服务器状态</h3> <p>严格来说，ectd节点有三种角色：Leader、Flower、Candidate。Leader：复制处理所有与客户端的交互和数据处理，协调follower，只有一个；Follower：听从Leader差遣；Candidate：当没有Leader的时候，所有服务器可以竞选Leader，向其他服务器拉票；</p> <p>节点角色会在以上三种角色中进行切换。</p> <h3 id="_2-2-核心架构"><a href="#_2-2-核心架构" class="header-anchor">#</a> 2.2 核心架构</h3> <p>etcd 整体架构图如所示。其中，etcd 有 etcd Server、gRPC Server、存储相关的 MVCC 、Snapshot、WAL，以及 Raft 模块。通过分层的方式，我们可以依次将其分为客户端层、API接口层、Raft层、逻辑层、数据存储层。</p> <p>(1)  客户端层</p> <p>客户端层包括clientv3 和 etcdctl 等客户端。用户通过命令行或者客户端调用提供了 RESTful 风格的 API，降低了 etcd 的使用复杂度。</p> <p>除此之外，客户端层的负载均衡和节点间故障转移等特性也提升了 etcd 服务端的高可用性。</p> <p>(2)  API接口层</p> <p>API 接口层提供了客户端访问服务端的通信协议和接口定义，以及服务端节点之间相互通信的协议。etcd 有V3和V2两个版本：</p> <p>etcd V3使用 gRPC 作为消息传输协议；</p> <p>etcd V2默认使用 HTTP/1.x 协议。</p> <p>对于不支持 gRPC 的客户端语言，etcd 提供 JSON 的 grpc-gateway 。通过 grpc-gateway 提供 RESTful代理，转换 HTTP/JSON 请求为 gRPC 的 Protocol Buffer 格式的消息。</p> <p>然而，值得注意的是，etcd V2 和 V3 是在底层使用同一套 Raft 算法的两个独立应用，但相互之间实现原理和使用方法上差别很大，接口不一样、存储不一样，两个版本的数据互相隔离。</p> <p>(1)  Raft层</p> <p>Raft 层作为etcd关键的基础模块，主要负责 Leader 选举和日志复制等功能，除了与本节点的 etcd Server 通信之外，还与集群中的其他 etcd 节点进行交互，实现分布式一致性数据同步的关键工作。</p> <p>(2)  逻辑层</p> <p>etcd 的业务逻辑层，包括鉴权、租约、KVServer、MVCC 和 Compactor 压缩等核心功能特性。</p> <p>(3)  数据存储层</p> <p>数据存储层中主要实现了快照、预写式日志 WAL。</p> <p><img src="/assets/img/etcd-2.png" alt="etcd-2"></p> <h3 id="_2-3-读写总体概述"><a href="#_2-3-读写总体概述" class="header-anchor">#</a> 2.3 读写总体概述</h3> <p>总览etcd各个模块间的交互，总体上的请求流程从上至下依次为客户端 → API 接口层 → etcd Server → etcd raft 算法库。</p> <h4 id="_2-3-1-读请求执行流程"><a href="#_2-3-1-读请求执行流程" class="header-anchor">#</a> 2.3.1 读请求执行流程</h4> <p>etcd 中一个读请求的具体执行流程如下：</p> <p>首先，客户端会创建一个 clientv3 库对象，通过负载均衡算法选择一个 etcd 节点，使用 KVServer 模块的 API 来访问 etcd server；</p> <p>然后，client 发送Range RPC请求到了server后就进入了KVServer模块；</p> <p>server 收到client的Range RPC请求后，根据ServiceName和RPC Method将请求转发到对应的handler实现；</p> <p>handler首先会将上面描述的一系列拦截器串联成一个拦截器再执行，在拦截器逻辑中，通过调用KVServer模块的Range接口获取数据。</p> <p>在etcd读请求的核心，需要经过线性读 ReadIndex 模块、MVCC（包含 treeIndex 和 BlotDB）模块。</p> <p>其中，线性读是相对串行读来讲的概念。集群模式下会有多个 etcd 节点，不同节点之间可能存在一致性问题，串行读直接返回状态数据，不需要与集群中其他节点交互。这种方式速度快，开销小，但是会存在数据不一致的情况。线性读则需要集群成员之间达成共识，存在开销，响应速度相对慢。但是能够保证数据的一致性，etcd 默认读模式是线性读。</p> <h4 id="_2-3-2-写请求执行流程"><a href="#_2-3-2-写请求执行流程" class="header-anchor">#</a> 2.3.2 写请求执行流程</h4> <p>etcd 一个写请求的完整执行流程，主要包括 Quota模块、KVServer模块、WAL模块、Apply模块和MVCC模块。</p> <p>首先，client端通过负载均衡算法选择一个etcd节点，发起 gRPC 调用；</p> <p>然后，etcd节点收到请求后经过gRPC拦截器、Quota 模块后，进入 KVServer 模块，Quota 模块用于校验 etcd db 文件大小是否超过了配额；</p> <p>KVServer模块向 Raft 模块提交一个提案，提案内容为“xxx”；</p> <p>随后此提案通过 Raft HTTP 网络模块转发、经过集群多数节点持久化后，状态会变成已提交；</p> <p>Etcd server 从 Raft 模块获取已提交的日志条目，传递给 Apply 模块；</p> <p>Apply 模块通过 MVCC 模块执行提案内容，更新状态机。</p> <p>与读流程不一样的是写流程还涉及 Quota、WAL、Apply 三个模块。此外，etcd 的 crash-safe 及幂等性也正是基于 WAL 和 Apply 流程的 consistent index 等实现的。</p> <h2 id="三、源码分析"><a href="#三、源码分析" class="header-anchor">#</a> 三、源码分析</h2> <h3 id="_3-1-源码结构及功能"><a href="#_3-1-源码结构及功能" class="header-anchor">#</a> 3.1 源码结构及功能</h3> <p>相较于以往的版本有所不同，etcd 项目(从 3.5 版开始)被组织成多个 golang 模块。具体目录结构如下：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>├─api               定义 etcd 客户端和服务器之间通信协议的 API 定义
├─CHANGELOG
├─client             Go语言客户端SDK
│  ├─pkg
│  ├─v2
│  └─v3
├─contrib             raftexample实现
├─Documentation
├─etcdctl             命令行客户端实现，用于访问和管理 etcd 的命令行工具
├─etcdutl             命令行管理实用程序，可直接操作etcd数据文件
├─hack               为开发人员提供的扩展
├─pkg                ectd使用的工具集合
├─raft                raft算法模块。分布式共识协议的实现
├─scripts              脚本、测试等相关内容
├─security             脚本、测试等相关内容
├─server               etcd server模块，etcd 内部实现
├─tests                一个包含所有 etcd 集成测试的模块
└─tools                脚本、测试等相关内容
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="_3-2-客户端设计"><a href="#_3-2-客户端设计" class="header-anchor">#</a> 3.2 客户端设计</h3> <p>作为etcd的基础模块，etcd 客户端包括 <code>client v2</code> 和 <code>v3</code> 两个大版本 API 客户端库，提供了简洁易用的 API，同时支持负载均衡、节点间故障自动转移，可极大降低业务使用 etcd 复杂度，提升开发效率、服务可用性。接下来，我们将以<code>client v3</code>版本为例，介绍客户端相关设计内容。</p> <h4 id="_3-2-1-client对象"><a href="#_3-2-1-client对象" class="header-anchor">#</a> 3.2.1 Client对象</h4> <p>要访问etcd第一件事就是创建client对象，而client对象需要传入一个Config配置，具体初始化方法如下：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>	cli<span class="token punctuation">,</span> err <span class="token operator">:=</span> clientv3<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>clientv3<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
		Endpoints<span class="token punctuation">:</span>   <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;localhost:2379&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		DialTimeout<span class="token punctuation">:</span> <span class="token number">5</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span> 	<span class="token punctuation">}</span>
		<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这里传了2个选项：</p> <ul><li>Endpoints：etcd的多个节点服务地址，因为我是单点测试，所以只传1个；</li> <li>DialTimeout：创建client的首次连接超时，这里传了5秒，如果5秒都没有连接成功就会返回err；值得注意的是，一旦client创建成功，我们就不用再关心后续底层连接的状态了，client内部会重连。</li></ul> <p>当然，如果上述<code>err != nil</code>，那么一般情况下我们可以选择重试几次，或者退出程序。</p> <p>这里我们重点了解一下Client 定义：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>client<span class="token operator">/</span>client<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span>
<span class="token comment">// Client provides and manages an etcd v3 client session.</span>
<span class="token keyword">type</span> Client <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Cluster
	KV
	Lease
	Watcher
	Auth
	Maintenance
	<span class="token comment">// Username is a user name for authentication.</span>
	Username <span class="token builtin">string</span>
	<span class="token comment">// Password is a password for authentication.</span>
	Password        <span class="token builtin">string</span>
<span class="token comment">// contains filtered or unexported fields</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>这里显示的都是可导出的模块结构字段，代表了客户端能够使用的几大核心模块，具体功能如下：</p> <p>(1) Cluster：向集群里增加 etcd 服务端节点之类，属于管理员操作；</p> <p>(2) KV：实际操作中主要使用的功能，即操作 K-V对象。实际上client.KV是一个interface，提供了关于k-v操作的所有方法，在使用过程中，常需要使用装饰者模式包装后的KV对象，对象中内置错误重试机制。具体代码如下:</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>client<span class="token operator">/</span>kv<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span>
<span class="token keyword">type</span> KV <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Put</span><span class="token punctuation">(</span>…<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>PutResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>               <span class="token comment">// 存储键值对</span>
	<span class="token function">Get</span><span class="token punctuation">(</span>…<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>GetResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>              <span class="token comment">// 检索键值对</span>
	<span class="token function">Delete</span><span class="token punctuation">(</span>…<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>DeleteResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>         <span class="token comment">// 删除键值对</span>
	<span class="token function">Compact</span><span class="token punctuation">(</span>…<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>CompactResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>     <span class="token comment">// 压缩给定版本之前的 KV 历史</span>
	<span class="token function">Do</span><span class="token punctuation">(</span>…<span class="token punctuation">)</span> <span class="token punctuation">(</span>OpResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>               <span class="token comment">// 指定某种没有事务的操作</span>
	<span class="token function">Txn</span><span class="token punctuation">(</span>…<span class="token punctuation">)</span> Txn                           <span class="token comment">// Txn 创建一个事务</span>
<span class="token punctuation">}</span>
client<span class="token operator">/</span>kv<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span>
<span class="token keyword">func</span> <span class="token function">NewKV</span><span class="token punctuation">(</span>c <span class="token operator">*</span>Client<span class="token punctuation">)</span> KV <span class="token punctuation">{</span>
	api <span class="token operator">:=</span> <span class="token operator">&amp;</span>kv<span class="token punctuation">{</span>remote<span class="token punctuation">:</span> <span class="token function">RetryKVClient</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">}</span>
	<span class="token keyword">if</span> c <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		api<span class="token punctuation">.</span>callOpts <span class="token operator">=</span> c<span class="token punctuation">.</span>callOpts
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> api
<span class="token punctuation">}</span>
client<span class="token operator">/</span>kv<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span>      
<span class="token comment">// 需要注意的是此处具体构建装饰的对象是KVClient</span>
<span class="token comment">// KVClient 对象是实际是KVService的客户端API。</span>
<span class="token keyword">type</span> kv <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	remote   pb<span class="token punctuation">.</span>KVClient
	callOpts <span class="token punctuation">[</span><span class="token punctuation">]</span>grpc<span class="token punctuation">.</span>CallOption
<span class="token punctuation">}</span>
client<span class="token operator">/</span>retry<span class="token punctuation">.</span><span class="token keyword">go</span><span class="token punctuation">:</span>
<span class="token comment">// RetryKVClient implements a KVClient.</span>
<span class="token keyword">func</span> <span class="token function">RetryKVClient</span><span class="token punctuation">(</span>c <span class="token operator">*</span>Client<span class="token punctuation">)</span> pb<span class="token punctuation">.</span>KVClient <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>retryKVClient<span class="token punctuation">{</span>
		kc<span class="token punctuation">:</span> pb<span class="token punctuation">.</span><span class="token function">NewKVClient</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>conn<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>(3) Lease：租约相关操作，比如申请一个 TTL=10 秒的租约。和获取KV对象一样，通过下面代码获取它：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> Lease <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Grant</span><span class="token punctuation">(</span>…<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>LeaseGrantResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>     分配租约
	<span class="token function">Revoke</span><span class="token punctuation">(</span>…<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>LeaseRevokeResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>  释放租约
	<span class="token function">TimeToLive</span><span class="token punctuation">(</span>…<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>LeaseTimeToLiveResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>  获取剩余TTL时间
	<span class="token function">Leases</span><span class="token punctuation">(</span>…<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>LeaseLeasesResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>  列举所有etcd中的租约
	<span class="token function">KeepAlive</span><span class="token punctuation">(</span>…<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token operator">*</span>LeaseKeepAliveResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>  自动定时的续约某个租约
	<span class="token function">KeepAliveOnce</span><span class="token punctuation">(</span>…<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>LeaseKeepAliveResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span>  为某个租约续约一次
	<span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>  关闭客户端建立的所有租约
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">NewLease</span><span class="token punctuation">(</span>c <span class="token operator">*</span>Client<span class="token punctuation">)</span> Lease <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">NewLeaseFromLeaseClient</span><span class="token punctuation">(</span><span class="token function">RetryLeaseClient</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> c<span class="token punctuation">.</span>cfg<span class="token punctuation">.</span>DialTimeout<span class="token operator">+</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>(4) Watcher：观察订阅，从而监听最新的数据变化；</p> <p>(5) Auth：管理 etcd 的用户和权限，属于管理员操作；</p> <p>(6) Maintenance：维护 etcd，比如主动迁移 etcd 的 leader 节点，属于管理员操作。</p> <h4 id="_3-2-2-grpc服务"><a href="#_3-2-2-grpc服务" class="header-anchor">#</a> 3.2.2 gRPC服务</h4> <p><code>etcd client v3</code>库针对gRPC服务的实现采用的负载均衡算法为 <code>Round-robin</code>。即针对每一个请求，<code>Round-robin</code> 算法通过轮询的方式依次从 <code>endpoint</code> 列表中选择一个 <code>endpoint</code> 访问(长连接)，使 <code>etcd server</code> 负载尽量均衡。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>client<span class="token operator">/</span>client<span class="token punctuation">.</span><span class="token keyword">go</span> <span class="token keyword">func</span> newClient<span class="token punctuation">:</span>
conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">dialWithBalancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
client<span class="token operator">/</span>client<span class="token punctuation">.</span><span class="token keyword">go</span>  建立了到etcd的服务端链接
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">dialWithBalancer</span><span class="token punctuation">(</span>dopts <span class="token operator">...</span>grpc<span class="token punctuation">.</span>DialOption<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>grpc<span class="token punctuation">.</span>ClientConn<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	creds <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">credentialsForEndpoint</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">Endpoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	opts <span class="token operator">:=</span> <span class="token function">append</span><span class="token punctuation">(</span>dopts<span class="token punctuation">,</span> grpc<span class="token punctuation">.</span><span class="token function">WithResolvers</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>resolver<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">dial</span><span class="token punctuation">(</span>creds<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
client<span class="token operator">/</span>client<span class="token punctuation">.</span><span class="token keyword">go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">dial</span><span class="token punctuation">(</span>creds grpccredentials<span class="token punctuation">.</span>TransportCredentials<span class="token punctuation">,</span> dopts <span class="token operator">...</span>grpc<span class="token punctuation">.</span>DialOption<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>grpc<span class="token punctuation">.</span>ClientConn<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 首先，ETCD通过这行代码，向GRPC框架加入了一些自己的</span>
    <span class="token comment">// 配置，比如：KeepAlive特性（配置里提到的配置项）、</span>
    <span class="token comment">// TLS证书配置、还有最重要的重试策略。</span>
	opts<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">dialSetupOpts</span><span class="token punctuation">(</span>creds<span class="token punctuation">,</span> dopts<span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token operator">...</span>
    <span class="token comment">// context 的一段经典样例代码</span>
    <span class="token comment">// 问：如果我同时把非零的DialTimeout和带超时的 context 传给客户端，</span>
    <span class="token comment">// 到底以哪个超时为准？</span>
    <span class="token comment">// 答：这里新建了子context(dctx)，父context和DialTimeout</span>
    <span class="token comment">// 哪个先到deadline，就以哪个为准。</span>
	dctx <span class="token operator">:=</span> c<span class="token punctuation">.</span>ctx
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>cfg<span class="token punctuation">.</span>DialTimeout <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">var</span> cancel context<span class="token punctuation">.</span>CancelFunc
		<span class="token comment">// 同时包含父context和DialTimeout</span>
		<span class="token comment">// 哪个先倒时间就以哪个为准。</span>
		dctx<span class="token punctuation">,</span> cancel <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>ctx<span class="token punctuation">,</span> c<span class="token punctuation">.</span>cfg<span class="token punctuation">.</span>DialTimeout<span class="token punctuation">)</span>
		<span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
	<span class="token punctuation">}</span>
    <span class="token comment">// 最终调用grpc.DialContext()建立连接</span>
	conn<span class="token punctuation">,</span> err <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">DialContext</span><span class="token punctuation">(</span>dctx<span class="token punctuation">,</span> target<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span>
	<span class="token operator">...</span>
	<span class="token keyword">return</span> conn<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h4 id="_3-2-3-重试策略分析"><a href="#_3-2-3-重试策略分析" class="header-anchor">#</a> 3.2.3 重试策略分析</h4> <p>自动重试是ETCD能提供高可用特性的重要保证，此处需要注意的是：自动重试不会在etcd集群的同一节点上进行，这跟我们平常做的重试不同，就如前面提到的 etcd是通过grpc框架提供对集群访问的负载均衡策略的，所以此时client端会轮询的重试集群的每个节点，此外，自动重试只会重试一些特定的错误。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">//client/client.go 这段代码在dialWithBalancer-&gt;dial-&gt;dialSetupOpts中</span>
<span class="token comment">// dialSetupOpts gives the dial opts prior to any authentication.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">dialSetupOpts</span><span class="token punctuation">(</span>creds grpccredentials<span class="token punctuation">.</span>TransportCredentials<span class="token punctuation">,</span> dopts <span class="token operator">...</span>grpc<span class="token punctuation">.</span>DialOption<span class="token punctuation">)</span> <span class="token punctuation">(</span>opts <span class="token punctuation">[</span><span class="token punctuation">]</span>grpc<span class="token punctuation">.</span>DialOption<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>cfg<span class="token punctuation">.</span>DialKeepAliveTime <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		params <span class="token operator">:=</span> keepalive<span class="token punctuation">.</span>ClientParameters<span class="token punctuation">{</span>
			Time<span class="token punctuation">:</span>                c<span class="token punctuation">.</span>cfg<span class="token punctuation">.</span>DialKeepAliveTime<span class="token punctuation">,</span>
			Timeout<span class="token punctuation">:</span>             c<span class="token punctuation">.</span>cfg<span class="token punctuation">.</span>DialKeepAliveTimeout<span class="token punctuation">,</span>
			PermitWithoutStream<span class="token punctuation">:</span> c<span class="token punctuation">.</span>cfg<span class="token punctuation">.</span>PermitWithoutStream<span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
		opts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> grpc<span class="token punctuation">.</span><span class="token function">WithKeepaliveParams</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	opts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> dopts<span class="token operator">...</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> creds <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		opts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> grpc<span class="token punctuation">.</span><span class="token function">WithTransportCredentials</span><span class="token punctuation">(</span>creds<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		opts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> grpc<span class="token punctuation">.</span><span class="token function">WithInsecure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Interceptor retry and backoff.</span>
	<span class="token comment">// TODO: Replace all of clientv3/retry.go with RetryPolicy:</span>
	<span class="token comment">// https://github.com/grpc/grpc-proto/blob/cdd9ed5c3d3f87aef62f373b93361cf7bddc620d/grpc/service_config/service_config.proto#L130</span>
	rrBackoff <span class="token operator">:=</span> <span class="token function">withBackoff</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">roundRobinQuorumBackoff</span><span class="token punctuation">(</span>defaultBackoffWaitBetween<span class="token punctuation">,</span> defaultBackoffJitterFraction<span class="token punctuation">)</span><span class="token punctuation">)</span>
	opts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span>
		<span class="token comment">// Disable stream retry by default since go-grpc-middleware/retry does not support client streams.</span>
		<span class="token comment">// Streams that are safe to retry are enabled individually.</span>
		grpc<span class="token punctuation">.</span><span class="token function">WithStreamInterceptor</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">streamClientInterceptor</span><span class="token punctuation">(</span><span class="token function">withMax</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rrBackoff<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		grpc<span class="token punctuation">.</span><span class="token function">WithUnaryInterceptor</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">unaryClientInterceptor</span><span class="token punctuation">(</span><span class="token function">withMax</span><span class="token punctuation">(</span>defaultUnaryMaxRetries<span class="token punctuation">)</span><span class="token punctuation">,</span> rrBackoff<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">)</span>
	<span class="token keyword">return</span> opts<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>看以上的代码，要自动重试只需两步：</p> <p>(1)  创建backoff函数，也就是计算重试等待时间的函数。</p> <p>(2)  通过WithXXXInterceptor()，注册重试拦截器，这样每次GRPC有请求都会回调该拦截器。</p> <p>值得注意的是，这里我们看到Stream的重试拦截器的注册，其最大重试次数设置为了0(withMax())，也就是不重试，这其实是故意为之，因为Client端的Stream重试不被支持，即Client端需要重试Stream，需要自己做单独处理，不能通过拦截器。</p> <p>首先看看如何计算等待时间：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">//client/client.go</span>
<span class="token comment">// waitBetween 重试间隔时长，jitterFraction 随机抖动率，</span>
<span class="token comment">// 比如：默认重试间隔为25ms,抖动率：0.1，</span>
<span class="token comment">// 那么实际重试间隔就在 25土2.5ms 之间，attempt 实际重试了多少次</span>
<span class="token comment">// roundRobinQuorumBackoff retries against quorum between each backoff.</span>
<span class="token comment">// This is intended for use with a round robin load balancer.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">roundRobinQuorumBackoff</span><span class="token punctuation">(</span>waitBetween time<span class="token punctuation">.</span>Duration<span class="token punctuation">,</span> jitterFraction <span class="token builtin">float64</span><span class="token punctuation">)</span> backoffFunc <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span>attempt <span class="token builtin">uint</span><span class="token punctuation">)</span> time<span class="token punctuation">.</span>Duration <span class="token punctuation">{</span>
		<span class="token comment">// after each round robin across quorum, backoff for our wait between duration</span>
		n <span class="token operator">:=</span> <span class="token function">uint</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">Endpoints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		quorum <span class="token operator">:=</span> <span class="token punctuation">(</span>n<span class="token operator">/</span><span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> attempt<span class="token operator">%</span>quorum <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			c<span class="token punctuation">.</span>lg<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">&quot;backoff&quot;</span><span class="token punctuation">,</span> zap<span class="token punctuation">.</span><span class="token function">Uint</span><span class="token punctuation">(</span><span class="token string">&quot;attempt&quot;</span><span class="token punctuation">,</span> attempt<span class="token punctuation">)</span><span class="token punctuation">,</span> zap<span class="token punctuation">.</span><span class="token function">Uint</span><span class="token punctuation">(</span><span class="token string">&quot;quorum&quot;</span><span class="token punctuation">,</span> quorum<span class="token punctuation">)</span><span class="token punctuation">,</span> zap<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span><span class="token string">&quot;waitBetween&quot;</span><span class="token punctuation">,</span> waitBetween<span class="token punctuation">)</span><span class="token punctuation">,</span> zap<span class="token punctuation">.</span><span class="token function">Float64</span><span class="token punctuation">(</span><span class="token string">&quot;jitterFraction&quot;</span><span class="token punctuation">,</span> jitterFraction<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token function">jitterUp</span><span class="token punctuation">(</span>waitBetween<span class="token punctuation">,</span> jitterFraction<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		c<span class="token punctuation">.</span>lg<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token string">&quot;backoff skipped&quot;</span><span class="token punctuation">,</span> zap<span class="token punctuation">.</span><span class="token function">Uint</span><span class="token punctuation">(</span><span class="token string">&quot;attempt&quot;</span><span class="token punctuation">,</span> attempt<span class="token punctuation">)</span><span class="token punctuation">,</span> zap<span class="token punctuation">.</span><span class="token function">Uint</span><span class="token punctuation">(</span><span class="token string">&quot;quorum&quot;</span><span class="token punctuation">,</span> quorum<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token number">0</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>可以发现的是roundRobinQuorumBackoff返回了一个闭包，内部是重试间隔时长计算逻辑，这个逻辑说来也简单：</p> <p>(1) 若重试次数已经达到集群的法定人数(quorum)，则真正的计算间隔时长，间隔时长到期后，才进行重试。</p> <p>(2) 否则，直接返回0，也就是马上重试。</p> <p>就如前面所提到的，负载均衡策略是轮询，而这个重试逻辑一定要配合负载均衡是轮询策略才能达到的效果：假如你访问集群中的一台节点失败，可能是那台节点出问题了，但如果整个集群是好的，这时候马上重试，轮询到下台节点就行。</p> <p>但是，如果重试多次，集群大多数节点（法定人数）都失败了，那应该是集群出问题了，这时候就需要计算间隔时间，等会儿再重试看看问题能不能解决。</p> <p>这里也可以看到etcd的Client端，考虑的细节问题是非常多的，一个简单的重试时间计算，也能进行逻辑上的小小优化。</p> <p>重试拦截器相关代码实现如下：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">unaryClientInterceptor</span><span class="token punctuation">(</span>optFuncs <span class="token operator">...</span>retryOption<span class="token punctuation">)</span> grpc<span class="token punctuation">.</span>UnaryClientInterceptor <span class="token punctuation">{</span>
		<span class="token operator">...</span> 
		<span class="token comment">// 如果最大重试次数设置为0，那就不重试。</span>
		<span class="token keyword">if</span> callOpts<span class="token punctuation">.</span>max <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token function">invoker</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> method<span class="token punctuation">,</span> req<span class="token punctuation">,</span> reply<span class="token punctuation">,</span> cc<span class="token punctuation">,</span> grpcOpts<span class="token operator">...</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">var</span> lastErr <span class="token builtin">error</span>
		<span class="token comment">// 开始重试计数</span>
		<span class="token keyword">for</span> attempt <span class="token operator">:=</span> <span class="token function">uint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> attempt <span class="token operator">&lt;</span> callOpts<span class="token punctuation">.</span>max<span class="token punctuation">;</span> attempt<span class="token operator">++</span> <span class="token punctuation">{</span>
		    <span class="token comment">// 计算重试间隔时间，并阻塞代码，等待</span>
		    <span class="token comment">// 这里最终会调用到 roundRobinQuorumBackoff 来计算时间</span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">waitRetryBackoff</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> attempt<span class="token punctuation">,</span> callOpts<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> err
			<span class="token punctuation">}</span>
		
		    <span class="token comment">// 再次重新执行GRPC请求</span>
			lastErr <span class="token operator">=</span> <span class="token function">invoker</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> method<span class="token punctuation">,</span> req<span class="token punctuation">,</span> reply<span class="token punctuation">,</span> cc<span class="token punctuation">,</span> grpcOpts<span class="token operator">...</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> lastErr <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			    <span class="token comment">// 重试成功，退出</span>
				<span class="token keyword">return</span> <span class="token boolean">nil</span>
			<span class="token punctuation">}</span>
			
			<span class="token comment">// 这段代码分析了两种情况</span>
			<span class="token comment">// 1. 服务端返回了 Context Error（超时、被取消），直接重试</span>
			<span class="token comment">// 2. 客户端的 Context 也出现了Error</span>
			<span class="token keyword">if</span> <span class="token function">isContextError</span><span class="token punctuation">(</span>lastErr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> ctx<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					<span class="token comment">// 客户端本身的ctx也报错了，不重试了，退出。</span>
					<span class="token keyword">return</span> lastErr
				<span class="token punctuation">}</span>
				<span class="token comment">// 服务端返回，直接重试</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
			
			<span class="token keyword">if</span> callOpts<span class="token punctuation">.</span>retryAuth <span class="token operator">&amp;&amp;</span> rpctypes<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>lastErr<span class="token punctuation">)</span> <span class="token operator">==</span> rpctypes<span class="token punctuation">.</span>ErrInvalidAuthToken <span class="token punctuation">{</span>
				<span class="token comment">// 是AuthToken不正确，重新获取Token</span>
				gterr <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
				<span class="token operator">...</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// 只有在特定错误才重试（code.Unavailable）</span>
			<span class="token comment">// 否则返回Err，不重试。</span>
			<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">isSafeRetry</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>lg<span class="token punctuation">,</span> lastErr<span class="token punctuation">,</span> callOpts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span> lastErr
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> lastErr
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><h3 id="_3-3-api-接口层设计"><a href="#_3-3-api-接口层设计" class="header-anchor">#</a> 3.3 API 接口层设计</h3> <h4 id="_3-3-1-通信方式概述"><a href="#_3-3-1-通信方式概述" class="header-anchor">#</a> 3.3.1 通信方式概述</h4> <p>时至今日，etcd通信方式经过了两次较为明显的版本更替。早期的etcd通信版本是v2，通过HTTP+JSON暴露外部API，由于经常需要服务感知节点配置变动或者监听推送，客户端和服务端需要频繁通信，早期的v2采用HTTP1.1的长连接来维持，经过如此通信效率依然不高。</p> <p>因此，etcd v3版本引进了grpc+protobuf的通信方式(基于HTTP/2.0)，其优势在于：</p> <p>(1)  采用二进制压缩传输，序列/反序列化更加高效</p> <p>(2)  基于HTTP2.0的服务端主动推送特性，对事件多路复用做了优化</p> <p>(3) Watch功能使用grpc的stream流进行感知，同一个客户端和服务端采用单一连接，替代v2的HTTP长轮询检测，直接减少连接数和内存开销</p> <p>etcd v3版本为了向上兼容v2 API版本，提供了grpc网关来支持原HTTP JSON接口支持。考虑到etcd v3版本提供了丰富的功能优化，后续的代码分析将以v3版本为主体进行介绍。</p> <h4 id="_3-3-2-etcd-v3"><a href="#_3-3-2-etcd-v3" class="header-anchor">#</a> 3.3.2 etcd v3</h4> <p>etcd v3在设计之初的通信基于 gRPC，proto 文件是定义服务端和客户端通讯接口的标准。即客户端该传什么样的参数，服务端该返回什么样子的参数，客户端该怎么调用，是阻塞还是非阻塞，是同步还是异步。</p> <p>在进行核心API接口层设计的学习之前，gRPC 推荐使用 proto3，我们需要对 proto3 的基本语法有初步的了解。proto3 是原有 Protocol Buffer 2(被称为 proto2)的升级版本，删除了一部分特性，优化了对移动设备的支持，另外增加了对android和ios的支持，使得 gRPC 可以顺利的在移动设备上使用。</p> <p>一个 .proto 文件的编译之后，编译器会为你选择的语言生成代码。你在文件中描述的消息类型，包括获取和设置字段的值，序列化你的消息到一个输出流，以及从一个输入流中转换出你的消息。</p> <p>(1) 对于 C++，编译器会为每个 .proto 文件生成一个 .h 和一个 .cc 的文件，为每一个给出的消息类型生成一个类。</p> <p>(2) 对于 Java，编译器会生成一个java文件，其中为每一个消息类型生成一个类，还有特殊的用来创建这些消息类实例的Builder类，</p> <p>(3) Python编译器生成一个模块，其中为每一个消息类型生成一个静态的描述器，在运行时，和一个 metaclass 一起使用来创建必要的 Python 数据访问类。</p> <p>(4) 对于 Go，编译器为每个消息类型生成一个 .pb.go 文件。</p> <h4 id="_3-3-3-grpc服务"><a href="#_3-3-3-grpc服务" class="header-anchor">#</a> 3.3.3 gRPC服务</h4> <p>在proto文件<code>(api/etcdserverpb/rpc.proto</code>)中，etcd 的 RPC 接口定义根据功能分类到服务中。</p> <p>其中，处理 etcd 键值的重要服务包括：</p> <ul><li><p>KV Service：创建、更新、获取和删除键值对；</p></li> <li><p>Watch Service：监视键的更改；</p></li> <li><p>Lease Service：实现键值对过期，客户端用来续租、保持心跳；</p></li> <li><p>Lock Service：etcd 提供分布式共享锁的支持；</p></li> <li><p>Election Service：暴露客户端选举机制；</p></li></ul> <p>这些服务统一在<code>api/etcdserverpb/*.proto</code>文件中进行了相应的声明。例如，这里是Range RPC描述：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>service KV <span class="token punctuation">{</span>
  <span class="token comment">// Range gets the keys in the range from the key-value store.</span>
  rpc <span class="token function">Range</span><span class="token punctuation">(</span>RangeRequest<span class="token punctuation">)</span> returns <span class="token punctuation">(</span>RangeResponse<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      option <span class="token punctuation">(</span>google<span class="token punctuation">.</span>api<span class="token punctuation">.</span>http<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        post<span class="token punctuation">:</span> <span class="token string">&quot;/v3/kv/range&quot;</span>
        body<span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
…<span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>此外，etcd API 的所有响应都有一个附加的响应标头，其中包括响应的群集元数据：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>message ResponseHeader <span class="token punctuation">{</span>
  <span class="token builtin">uint64</span> cluster_id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token comment">// 产生响应的集群的 ID</span>
  <span class="token builtin">uint64</span> member_id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>   <span class="token comment">// 产生响应的成员的 ID</span>
  <span class="token builtin">int64</span> revision <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>      <span class="token comment">// 产生响应时键值存储的修订版本号</span>
  <span class="token builtin">uint64</span> raft_term <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>    <span class="token comment">//产生响应时，成员的 Raft 称谓</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>这些元数据在实际使用过程中，都提供了如下功能：</p> <p>(1) 应用服务可以通过 Cluster_ID 和 Member_ID 字段来确保，当前与之通信的正是预期的那个集群或者成员；</p> <p>(2) 应用服务可以使用修订号字段来知悉当前键值存储库最新的修订号。当应用程序指定历史修订版以进行时程查询并希望在请求时知道最新修订版时，此功能特别有用；</p> <p>(3) 应用服务可以使用 Raft_Term 来检测集群何时完成一个新的 leader 选举；</p> <h3 id="_3-4-服务端设计"><a href="#_3-4-服务端设计" class="header-anchor">#</a> 3.4 服务端设计</h3> <p>作为etcd的最核心模块，etcd 服务端模块定义了主要的接口以及数据交互格式，并解决以下问题：接收客户端的请求并对节点进行分发；感知集群成员变动，对成员通知；同步或者启动恢复快照等。</p> <p>Etcd 服务端主要由几大组件构成，各部分介绍如下：</p> <p>(1) <code>EtcdServer[etcdserver/server.go]</code> 主进程，直接或者间接包含了raftNode、WAL、snapshotter 等多个核心组件，可以理解为一个容器。</p> <p>(2) <code>raftNode[etcdserver/raft.go]</code> 对内部 RAFT 协议实现的封装，暴露简单的接口，用来保证写事务的集群一致性。</p> <p>接下来，将以EtcdServer为核心进行源码分析，有关具体的Raft协议内容，将会在下一节具体给出。</p> <h4 id="_3-4-1-server对象"><a href="#_3-4-1-server对象" class="header-anchor">#</a> 3.4.1 Server对象</h4> <p>ETCD 服务器是通过 EtcdServer 结构抽象，对应了 etcdserver/server.go 中的代码，包含属性 r raftNode，代表 RAFT 集群中的一个节点，启动入口在 etcdmain/main.go 文件中。具体代码如下：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// etcdmain/main.go</span>
<span class="token keyword">func</span> <span class="token function">Main</span><span class="token punctuation">(</span>args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">checkSupportArch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token punctuation">{</span>
		cmd <span class="token operator">:=</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
		<span class="token keyword">switch</span> cmd <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token string">&quot;gateway&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;grpc-proxy&quot;</span><span class="token punctuation">:</span>
			<span class="token keyword">if</span> err <span class="token operator">:=</span> rootCmd<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				fmt<span class="token punctuation">.</span><span class="token function">Fprint</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
				os<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">startEtcdOrProxyV2</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// embed/etcd.go 此处列出部分字段</span>
<span class="token comment">// Etcd contains a running etcd server and its listeners.</span>
<span class="token keyword">type</span> Etcd <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Peers   <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>peerListener
	Clients <span class="token punctuation">[</span><span class="token punctuation">]</span>net<span class="token punctuation">.</span>Listener
	<span class="token comment">// a map of contexts for the servers that serves client requests.</span>
	sctxs            <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>serveCtx
	metricsListeners <span class="token punctuation">[</span><span class="token punctuation">]</span>net<span class="token punctuation">.</span>Listener
…
<span class="token comment">// 核心对象服务器接口的生产实现</span>
	Server <span class="token operator">*</span>etcdserver<span class="token punctuation">.</span>EtcdServer
…
<span class="token punctuation">}</span>
<span class="token comment">// 启动调用链过程(考虑到服务器的分析的复杂性，此处通过函数分支的方式进行介绍)</span>
<span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                etcdmain<span class="token operator">/</span>main<span class="token punctuation">.</span><span class="token keyword">go</span>
 <span class="token operator">|</span><span class="token operator">-</span><span class="token function">checkSupportArch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token operator">|</span><span class="token operator">-</span><span class="token function">startEtcdOrProxyV2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>               etcdmain<span class="token operator">/</span>etcd<span class="token punctuation">.</span><span class="token keyword">go</span>
   <span class="token operator">|</span><span class="token operator">-</span><span class="token function">newConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token operator">|</span><span class="token operator">-</span><span class="token function">setupLogging</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token operator">|</span><span class="token operator">-</span><span class="token function">startEtcd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
     <span class="token comment">// 为客户端/服务器通信启动etcd服务器和HTTP处理程序。</span>
   <span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span>embed<span class="token punctuation">.</span><span class="token function">StartEtcd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>              embed<span class="token operator">/</span>etcd<span class="token punctuation">.</span><span class="token keyword">go</span> 
   <span class="token operator">|</span>   <span class="token operator">|</span><span class="token operator">-</span><span class="token function">configurePeerListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      
   <span class="token operator">|</span>   <span class="token operator">|</span><span class="token operator">-</span><span class="token function">configureClientListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token operator">|</span>   <span class="token operator">|</span><span class="token operator">-</span>EtcdServer<span class="token punctuation">.</span><span class="token function">ServerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    生成新的配置
   <span class="token operator">|</span>   <span class="token operator">|</span><span class="token operator">-</span>EtcdServer<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>       etcdserver<span class="token operator">/</span>server<span class="token punctuation">.</span><span class="token keyword">go</span>正式启动RAFT服务<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>
   <span class="token operator">|</span>   <span class="token operator">|</span><span class="token operator">-</span>EtcdServer<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>           开始启动服务
   <span class="token operator">|</span>   <span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span>EtcdServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>           执行服务器开始服务请求所需的任何初始化
   <span class="token operator">|</span>   <span class="token operator">|</span>   <span class="token operator">|</span><span class="token operator">-</span>wait<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>               新建WaitGroup组以及一些管道服务
   <span class="token operator">|</span>   <span class="token operator">|</span>   <span class="token operator">|</span><span class="token operator">-</span>EtcdServer<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>         etcdserver<span class="token operator">/</span>raft<span class="token punctuation">.</span><span class="token keyword">go</span> 启动应用层的处理协程<span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span><span class="token number">2</span><span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>
   <span class="token operator">|</span>   <span class="token operator">|</span>   <span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span>raft<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>             启动处理协程
   <span class="token operator">|</span>   <span class="token operator">|</span><span class="token operator">-</span>Etcd<span class="token punctuation">.</span><span class="token function">servePeers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            启动集群内部通讯
   <span class="token operator">|</span>   <span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span>etcdhttp<span class="token punctuation">.</span><span class="token function">NewPeerHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  新建http<span class="token punctuation">.</span>Handler来处理etcd中其他成员请求
   <span class="token operator">|</span>   <span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span>srv<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                配置http服务
   <span class="token operator">|</span>   <span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span>e<span class="token punctuation">.</span><span class="token function">errHandler</span><span class="token punctuation">(</span>l<span class="token punctuation">.</span><span class="token function">serve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>       启动集群间http协程，开始多路传输监听
   <span class="token operator">|</span>   <span class="token operator">|</span><span class="token operator">-</span>Etcd<span class="token punctuation">.</span><span class="token function">serveClients</span><span class="token punctuation">(</span><span class="token punctuation">)</span>           启动协程处理客户请求
   <span class="token operator">|</span>   <span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span>http<span class="token punctuation">.</span><span class="token function">NewServeMux</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        启动监听客户端的协程
   <span class="token operator">|</span>   <span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span>sctxs<span class="token punctuation">.</span><span class="token function">serve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>               启动服务器
   <span class="token operator">|</span>   <span class="token operator">|</span>   <span class="token operator">|</span><span class="token operator">-</span>v3rpc<span class="token punctuation">.</span><span class="token function">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span>             启动gRPC服务 <span class="token operator">/</span>etcdserver<span class="token operator">/</span>api<span class="token operator">/</span>v3rpc<span class="token operator">/</span>grpc<span class="token punctuation">.</span><span class="token keyword">go</span>
   <span class="token operator">|</span>   <span class="token operator">|</span>   <span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span>grpc<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>         调用gRPC的接口创建
   <span class="token operator">|</span>   <span class="token operator">|</span>   <span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span>pb<span class="token punctuation">.</span><span class="token function">RegisterKVServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    注册各种的服务，这里包含了多个
   <span class="token operator">|</span>   <span class="token operator">|</span>   <span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span>pb<span class="token punctuation">.</span><span class="token function">RegisterWatchServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token operator">|</span>   <span class="token operator">|</span><span class="token operator">-</span>Etcd<span class="token punctuation">.</span><span class="token function">serveMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token operator">|</span><span class="token operator">-</span><span class="token function">notifySystemd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token operator">|</span><span class="token operator">-</span><span class="token keyword">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                         等待stopped
   <span class="token operator">|</span><span class="token operator">-</span>osutil<span class="token punctuation">.</span><span class="token function">Exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br></div></div><p>在标记 1 处会启动 RAFT 协议的核心部分，也就是<code>node.run()[raft/node.go]</code> 。</p> <p>在标记 2 处启动的是 ETCD 应用层的处理协程，对应了 <code>raftNode.start()[etcdserver/raft.go]</code> 。</p> <p>这里基本上是大致的启动流程，主要是解析参数，设置日志，启动监听端口等，接下来就是其核心部分 <code>etcdserver.NewServer()</code> 。</p> <p>应用通过 <code>raft.StartNode()</code> 来启动 raft 中的一个副本，函数内部会通过启动一个 goroutine 运行。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">//etcdserver/server.go</span>
<span class="token comment">// NewServer creates a new EtcdServer from the supplied configuration. The</span>
<span class="token comment">// configuration is considered static for the lifetime of the EtcdServer.</span>
<span class="token keyword">func</span> <span class="token function">NewServer</span><span class="token punctuation">(</span>cfg config<span class="token punctuation">.</span>ServerConfig<span class="token punctuation">)</span> <span class="token punctuation">(</span>srv <span class="token operator">*</span>EtcdServer<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	b<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>
<span class="token comment">//…</span>
	sstats <span class="token operator">:=</span> stats<span class="token punctuation">.</span><span class="token function">NewServerStats</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> b<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>cl<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	lstats <span class="token operator">:=</span> stats<span class="token punctuation">.</span><span class="token function">NewLeaderStats</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>Logger<span class="token punctuation">,</span> b<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>nodeID<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	heartbeat <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>TickMs<span class="token punctuation">)</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Millisecond
	srv <span class="token operator">=</span> <span class="token operator">&amp;</span>EtcdServer<span class="token punctuation">{</span>
…
r<span class="token punctuation">:</span>                     <span class="token operator">*</span>b<span class="token punctuation">.</span>raft<span class="token punctuation">.</span><span class="token function">newRaftNode</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>ss<span class="token punctuation">,</span> b<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>wal<span class="token punctuation">.</span>w<span class="token punctuation">,</span> b<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>cl<span class="token punctuation">)</span><span class="token punctuation">,</span>
…
	<span class="token punctuation">}</span>
	serverID<span class="token punctuation">.</span><span class="token function">With</span><span class="token punctuation">(</span>prometheus<span class="token punctuation">.</span>Labels<span class="token punctuation">{</span><span class="token string">&quot;server_id&quot;</span><span class="token punctuation">:</span> b<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>nodeID<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	srv<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span><span class="token function">SetVersionChangedNotifier</span><span class="token punctuation">(</span>srv<span class="token punctuation">.</span>clusterVersionChanged<span class="token punctuation">)</span>
	srv<span class="token punctuation">.</span>applyV2 <span class="token operator">=</span> <span class="token function">NewApplierV2</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>Logger<span class="token punctuation">,</span> srv<span class="token punctuation">.</span>v2store<span class="token punctuation">,</span> srv<span class="token punctuation">.</span>cluster<span class="token punctuation">)</span>
	srv<span class="token punctuation">.</span>be <span class="token operator">=</span> b<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>backend<span class="token punctuation">.</span>be
	srv<span class="token punctuation">.</span>beHooks <span class="token operator">=</span> b<span class="token punctuation">.</span>storage<span class="token punctuation">.</span>backend<span class="token punctuation">.</span>beHooks
	minTTL <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">*</span>cfg<span class="token punctuation">.</span>ElectionTicks<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> heartbeat
	<span class="token comment">// always recover lessor before kv. When we recover the mvcc.KV it will reattach keys to its leases.</span>
	<span class="token comment">// If we recover mvcc.KV first, it will attach the keys to the wrong lessor before it recovers.</span>
	srv<span class="token punctuation">.</span>lessor <span class="token operator">=</span> lease<span class="token punctuation">.</span><span class="token function">NewLessor</span><span class="token punctuation">(</span>…
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	tp<span class="token punctuation">,</span> err <span class="token operator">:=</span> auth<span class="token punctuation">.</span><span class="token function">NewTokenProvider</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>Logger<span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>AuthToken<span class="token punctuation">,</span>
		<span class="token keyword">func</span><span class="token punctuation">(</span>index <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> srv<span class="token punctuation">.</span>applyWait<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>TokenTTL<span class="token punctuation">)</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">,</span>
	<span class="token punctuation">)</span>
<span class="token comment">//…</span>
	mvccStoreConfig <span class="token operator">:=</span> mvcc<span class="token punctuation">.</span>StoreConfig<span class="token punctuation">{</span>
		CompactionBatchLimit<span class="token punctuation">:</span>    cfg<span class="token punctuation">.</span>CompactionBatchLimit<span class="token punctuation">,</span>
		CompactionSleepInterval<span class="token punctuation">:</span> cfg<span class="token punctuation">.</span>CompactionSleepInterval<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	srv<span class="token punctuation">.</span>kv <span class="token operator">=</span> mvcc<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>srv<span class="token punctuation">.</span><span class="token function">Logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> srv<span class="token punctuation">.</span>be<span class="token punctuation">,</span> srv<span class="token punctuation">.</span>lessor<span class="token punctuation">,</span> mvccStoreConfig<span class="token punctuation">)</span>
	srv<span class="token punctuation">.</span>corruptionChecker <span class="token operator">=</span> <span class="token function">newCorruptionChecker</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>Logger<span class="token punctuation">,</span> srv<span class="token punctuation">,</span> srv<span class="token punctuation">.</span>kv<span class="token punctuation">.</span><span class="token function">HashStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	srv<span class="token punctuation">.</span>authStore <span class="token operator">=</span> auth<span class="token punctuation">.</span><span class="token function">NewAuthStore</span><span class="token punctuation">(</span>srv<span class="token punctuation">.</span><span class="token function">Logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> schema<span class="token punctuation">.</span><span class="token function">NewAuthBackend</span><span class="token punctuation">(</span>srv<span class="token punctuation">.</span><span class="token function">Logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> srv<span class="token punctuation">.</span>be<span class="token punctuation">)</span><span class="token punctuation">,</span> tp<span class="token punctuation">,</span> <span class="token function">int</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>BcryptCost<span class="token punctuation">)</span><span class="token punctuation">)</span>
	newSrv <span class="token operator">:=</span> srv <span class="token comment">// since srv == nil in defer if srv is returned as nil</span>
<span class="token comment">//…</span>
	<span class="token keyword">if</span> num <span class="token operator">:=</span> cfg<span class="token punctuation">.</span>AutoCompactionRetention<span class="token punctuation">;</span> num <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		srv<span class="token punctuation">.</span>compactor<span class="token punctuation">,</span> err <span class="token operator">=</span> v3compactor<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>Logger<span class="token punctuation">,</span> cfg<span class="token punctuation">.</span>AutoCompactionMode<span class="token punctuation">,</span> num<span class="token punctuation">,</span> srv<span class="token punctuation">.</span>kv<span class="token punctuation">,</span> srv<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
		<span class="token punctuation">}</span>
		srv<span class="token punctuation">.</span>compactor<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">=</span> srv<span class="token punctuation">.</span><span class="token function">restoreAlarms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	srv<span class="token punctuation">.</span>uberApply <span class="token operator">=</span> srv<span class="token punctuation">.</span><span class="token function">NewUberApplier</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> srv<span class="token punctuation">.</span>Cfg<span class="token punctuation">.</span>EnableLeaseCheckpoint <span class="token punctuation">{</span>
		<span class="token comment">// setting checkpointer enables lease checkpoint feature.</span>
		srv<span class="token punctuation">.</span>lessor<span class="token punctuation">.</span><span class="token function">SetCheckpointer</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> cp <span class="token operator">*</span>pb<span class="token punctuation">.</span>LeaseCheckpointRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			srv<span class="token punctuation">.</span><span class="token function">raftRequestOnce</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> pb<span class="token punctuation">.</span>InternalRaftRequest<span class="token punctuation">{</span>LeaseCheckpoint<span class="token punctuation">:</span> cp<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Set the hook after EtcdServer finishes the initialization to avoid</span>
	<span class="token comment">// the hook being called during the initialization process.</span>
	srv<span class="token punctuation">.</span>be<span class="token punctuation">.</span><span class="token function">SetTxPostLockInsideApplyHook</span><span class="token punctuation">(</span>srv<span class="token punctuation">.</span><span class="token function">getTxPostLockInsideApplyHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">// TODO: move transport initialization near the definition of remote</span>
	tr <span class="token operator">:=</span> <span class="token operator">&amp;</span>rafthttp<span class="token punctuation">.</span>Transport<span class="token punctuation">{</span>…
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> err <span class="token operator">=</span> tr<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
	<span class="token punctuation">}</span>
	<span class="token comment">// add all remotes into transport</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> m <span class="token operator">:=</span> <span class="token keyword">range</span> b<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>remotes <span class="token punctuation">{</span>
		<span class="token keyword">if</span> m<span class="token punctuation">.</span>ID <span class="token operator">!=</span> b<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>nodeID <span class="token punctuation">{</span>
			tr<span class="token punctuation">.</span><span class="token function">AddRemote</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> m<span class="token punctuation">.</span>PeerURLs<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> m <span class="token operator">:=</span> <span class="token keyword">range</span> b<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>cl<span class="token punctuation">.</span><span class="token function">Members</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> m<span class="token punctuation">.</span>ID <span class="token operator">!=</span> b<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>nodeID <span class="token punctuation">{</span>
			tr<span class="token punctuation">.</span><span class="token function">AddPeer</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> m<span class="token punctuation">.</span>PeerURLs<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	srv<span class="token punctuation">.</span>r<span class="token punctuation">.</span>transport <span class="token operator">=</span> tr
	<span class="token keyword">return</span> srv<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token comment">// 函数调用关系链</span>
<span class="token function">NewServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  etcdserver<span class="token operator">/</span>server<span class="token punctuation">.</span><span class="token keyword">go</span> 通过配置创建一个新的EtcdServer对象，不同场景不同
 <span class="token operator">|</span><span class="token operator">-</span><span class="token function">bootstrap</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>
 <span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span><span class="token function">bootstrapSnapshot</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>  新建snap对象，等待存储或恢复
 <span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span>wal<span class="token punctuation">.</span><span class="token function">Exist</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span>v2store<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                  初始化内存B<span class="token operator">+</span>树
 <span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span><span class="token function">bootstrapBackend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>             初始化操作treeIndex以及BoltDB持久化的对象
 <span class="token operator">|</span>   <span class="token operator">|</span><span class="token operator">-</span><span class="token function">recoverSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            从快照中恢复
 <span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span><span class="token function">bootstrapWALFromSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    已有WAL，在原有数据中恢复未提交数据
 <span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span><span class="token function">bootstrapCluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span>               对于每一个集群成员进行存储配置
 <span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span><span class="token function">bootstrapStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>               对于没有WAL情况，进行统一分配存储
 <span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span>cluster<span class="token punctuation">.</span><span class="token function">Finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                 对于每一个集群成员进行最后配置
 <span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span><span class="token function">bootstrapRaft</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                   为当前服务器配置raft 对象
 <span class="token operator">|</span><span class="token operator">-</span>stats<span class="token punctuation">.</span><span class="token function">NewServerStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span>              配置server状态
 <span class="token operator">|</span><span class="token operator">-</span>stats<span class="token punctuation">.</span><span class="token function">NewLeaderStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span>             成为Leader状态
 <span class="token operator">|</span><span class="token operator">-</span>srv<span class="token operator">=</span><span class="token operator">&amp;</span>EtcdServer<span class="token punctuation">{</span>raft<span class="token punctuation">.</span><span class="token function">newRaftNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> …<span class="token punctuation">}</span>新建etcdserver对象，并初始化raft对象运行
 <span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span>raft<span class="token punctuation">.</span><span class="token function">RestartNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  若无其他成员则重启节点
 <span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span>raft<span class="token punctuation">.</span><span class="token function">StartNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    若有则新启节点
 <span class="token operator">|</span>   <span class="token operator">|</span><span class="token operator">-</span><span class="token function">setupNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                     配置节点
 <span class="token operator">|</span>   <span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span>rn <span class="token operator">=</span> <span class="token function">NewRawNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                 raft<span class="token operator">/</span>node<span class="token punctuation">.</span><span class="token keyword">go</span> 新建一个<span class="token keyword">type</span> node <span class="token keyword">struct</span>对象
 <span class="token operator">|</span>   <span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span>rn<span class="token punctuation">.</span><span class="token function">Bootstrap</span><span class="token punctuation">(</span>peers<span class="token punctuation">)</span>                  通过追加配置来初始化RawNode
 <span class="token operator">|</span>   <span class="token operator">|</span>   <span class="token operator">|</span><span class="token operator">-</span>raft<span class="token punctuation">.</span><span class="token function">becomeFollower</span><span class="token punctuation">(</span><span class="token punctuation">)</span>             成为Follower状态
 <span class="token operator">|</span>   <span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span>n <span class="token operator">:=</span> <span class="token function">newNode</span><span class="token punctuation">(</span>rn<span class="token punctuation">)</span>                   封装rawNode
 <span class="token operator">|</span>   <span class="token operator">|</span><span class="token operator">-</span><span class="token keyword">go</span> node<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                     循环运行节点监听任务
<span class="token operator">|</span><span class="token operator">-</span>lease<span class="token punctuation">.</span><span class="token function">NewLessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                 恢复Lessor状态 mvcc<span class="token punctuation">.</span>New
 <span class="token operator">|</span><span class="token operator">-</span> mvcc<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                      新建mvcc存储管理对象
 <span class="token operator">|</span><span class="token operator">-</span>auth<span class="token punctuation">.</span><span class="token function">NewAuthStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>               
raft<span class="token punctuation">.</span><span class="token function">StartNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                     <span class="token operator">&lt;=</span><span class="token operator">==</span><span class="token operator">=</span>会根据不同的启动场景执行相关任务
 <span class="token operator">|</span><span class="token operator">-</span><span class="token function">setupNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   新建一个节点
 <span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span>rn <span class="token operator">=</span> <span class="token function">NewRawNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                 raft<span class="token operator">/</span>node<span class="token punctuation">.</span><span class="token keyword">go</span> 新建一个<span class="token keyword">type</span> node <span class="token keyword">struct</span>对象
 <span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span> rn<span class="token punctuation">.</span><span class="token function">Bootstrap</span><span class="token punctuation">(</span>peers<span class="token punctuation">)</span>                  通过追加配置来初始化RawNode
<span class="token comment">//这里会对关键对象初始化以及赋值，包括step=stepFollower r.tick=r.tickElection函数</span>
 <span class="token operator">|</span>   <span class="token operator">|</span><span class="token operator">-</span>raft<span class="token punctuation">.</span><span class="token function">becomeFollower</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
 <span class="token operator">|</span>   <span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span>raft<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                               开始启动时设置term为<span class="token number">1</span>
 <span class="token operator">|</span>   <span class="token operator">|</span>    <span class="token operator">|</span><span class="token operator">-</span>raft<span class="token punctuation">.</span><span class="token function">resetRandomizedElectionTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 更新选举的随机超时时间
 <span class="token operator">|</span>   <span class="token operator">|</span><span class="token operator">-</span>raftLog<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">)</span>               将配置更新日志添加
 <span class="token operator">|</span><span class="token operator">-</span>node<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>       raft<span class="token operator">/</span>node<span class="token punctuation">.</span><span class="token keyword">go</span> 节点运行，会启动一个协程运行 <span class="token operator">&lt;&lt;</span><span class="token operator">&lt;</span>long running<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span>
 <span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span>node<span class="token punctuation">.</span>rn<span class="token punctuation">.</span><span class="token function">readyWithoutAccept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token operator">|</span>     <span class="token operator">|</span><span class="token operator">-</span><span class="token function">newReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                   新建<span class="token keyword">type</span> Ready对象
 <span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span>raft<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      等待n<span class="token punctuation">.</span>tickc管道，这里实际就是在上面赋值的<span class="token function">tickElection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>函数
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br></div></div><p>这里稍微提一下mvcc，mvcc是数据库中常见的一种并发控制的方式，即保存数据的多个版本，在同一个事务里，应用所见的版本是一致的。</p> <p>在etcd中，mvcc底层使用 bolt 实现，bolt是一个基于B+树的KV存储。不同于以往认知，实际在存储过程中，Key是revision，而Value是用户给出的KV。为此，内存里维护了一个treeIndex的B+树，它存储了所有KV的所有版本记录。在查询数据时，先要通过内存btree在keyIndex.generations[0].revs中找到最后一条revision，即可去bbolt中读取对应的数据。相应的，etcd支持按key前缀查询，其实也就是遍历btree的同时根据revision去bbolt中获取用户的value。</p> <p>与此同时，etcd封装了backend接口用来操作treeIndex以及BoltDB的持久化，使其能够从内存到磁盘BoltDB持久化流程。使用*bolt.DB来操作boltDB数据库。这里不展开各个操作的细节。</p> <h4 id="_3-4-2-grpc-服务"><a href="#_3-4-2-grpc-服务" class="header-anchor">#</a> 3.4.2 gRPC 服务</h4> <p>与客户端gRPC服务相似，服务器 RPC 接口的定义在 <code>etcdserver/etcdserverpb/rpc.proto</code> 文件中，对应了 service KV 中的定义，而真正的启动对应了 <code>api/v3rpc/grpc.go</code> 中的实现。</p> <p>以 KV 存储为例，其对应了 <code>NewQuotaKVServer</code>() 中的实现，这里实际上是封装了一层，用来检查是否有足够的空间。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code>quotaKVServer<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span><span class="token punctuation">)</span> api<span class="token operator">/</span>v3rpc<span class="token operator">/</span>quota<span class="token punctuation">.</span><span class="token keyword">go</span> 首先检查是否满足需求
 <span class="token operator">|</span><span class="token operator">-</span>quotoAlarm<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 检查
 <span class="token operator">|</span><span class="token operator">-</span>KVServer<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span><span class="token punctuation">)</span> api<span class="token operator">/</span>v3rpc<span class="token operator">/</span>key<span class="token punctuation">.</span><span class="token keyword">go</span> 真正的处理请求
   <span class="token operator">|</span><span class="token operator">-</span><span class="token function">checkPutRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 校验请求参数是否合法
   <span class="token operator">|</span><span class="token operator">-</span>RaftKV<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span><span class="token punctuation">)</span> etcdserver<span class="token operator">/</span>v3_server<span class="token punctuation">.</span><span class="token keyword">go</span> 处理请求
   <span class="token operator">|=</span>EtcdServer<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 实际调用的是该函数
   <span class="token operator">|</span> <span class="token operator">|</span><span class="token operator">-</span><span class="token function">raftRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token operator">|</span>   <span class="token operator">|</span><span class="token operator">-</span><span class="token function">raftRequestOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token operator">|</span>     <span class="token operator">|</span><span class="token operator">-</span><span class="token function">processInternalRaftRequestOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 真正开始处理请求
   <span class="token operator">|</span>       <span class="token operator">|</span><span class="token operator">-</span>context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 创建超时的上下文信息
   <span class="token operator">|</span>       <span class="token operator">|</span><span class="token operator">-</span>raftNode<span class="token punctuation">.</span><span class="token function">Propose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> raft<span class="token operator">/</span>node<span class="token punctuation">.</span><span class="token keyword">go</span>
   <span class="token operator">|</span>         <span class="token operator">|</span><span class="token operator">-</span>raftNode<span class="token punctuation">.</span><span class="token function">step</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 对于类型为MsgProp类型消息，向propc通道中传入数据
   <span class="token operator">|</span><span class="token operator">-</span>header<span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token punctuation">)</span> etcdserver<span class="token operator">/</span>api<span class="token operator">/</span>v3rpc<span class="token operator">/</span>header<span class="token punctuation">.</span><span class="token keyword">go</span>填充响应的头部信息
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h4 id="_3-4-3-处理流程"><a href="#_3-4-3-处理流程" class="header-anchor">#</a> 3.4.3 处理流程</h4> <p>在运行处理数据过程中，etcd 服务端采用的是异步状态机，基于 GoLang 的 Channel 机制，RAFT 状态机作为一个 Background Thread/Routine 运行，会通过 Channel 接收上层传来的消息，状态机处理完成之后，再通过 Ready() 接口返回给上层。</p> <p>其中 type Ready struct 结构体封装了一批更新操作，具体代码如下所示：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token operator">/</span> Ready encapsulates the entries and messages that are ready to read<span class="token punctuation">,</span>
<span class="token comment">// be saved to stable storage, committed or sent to other peers.</span>
<span class="token comment">// All fields in Ready are read-only.</span>
<span class="token keyword">type</span> Ready <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span>SoftState
    pb<span class="token punctuation">.</span>HardState
    ReadStates <span class="token punctuation">[</span><span class="token punctuation">]</span>ReadState
    Entries <span class="token punctuation">[</span><span class="token punctuation">]</span>pb<span class="token punctuation">.</span>Entry
    Snapshot pb<span class="token punctuation">.</span>Snapshot
    CommittedEntries <span class="token punctuation">[</span><span class="token punctuation">]</span>pb<span class="token punctuation">.</span>Entry
    Messages <span class="token punctuation">[</span><span class="token punctuation">]</span>pb<span class="token punctuation">.</span>Message
    MustSync <span class="token builtin">bool</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>其中包括了：</p> <p>(1) pb.HardState 需要在发送消息前持久化的消息，包含当前节点见过的最大的 term，在这个 term 给谁投过票，已经当前节点知道的 commit index；</p> <p>(2) Messages 需要广播给所有 peers 的消息；</p> <p>(3) CommittedEntries 已经提交但是还没有apply到状态机的日志；</p> <p>(4) Snapshot 需要持久化的快照。</p> <p>在 <code>raft/node.go</code> 中定义了 type node struct 对应的结构，一个 RAFT 结构通过 Node 表示各结点信息，该结构体内定义了各个管道，用于同步信息，下面会逐一遇到。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> node <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    propc      <span class="token keyword">chan</span> pb<span class="token punctuation">.</span>Message
    recvc      <span class="token keyword">chan</span> pb<span class="token punctuation">.</span>Message
    confc      <span class="token keyword">chan</span> pb<span class="token punctuation">.</span>ConfChange
    confstatec <span class="token keyword">chan</span> pb<span class="token punctuation">.</span>ConfState
    readyc     <span class="token keyword">chan</span> Ready
    advancec   <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    tickc      <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    done       <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    stop       <span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    status     <span class="token keyword">chan</span> <span class="token keyword">chan</span> Status
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>库的使用者从 type node struct 结构体提供的 ready channel 中不断 pop 出一个个 Ready 进行处理，库使用者通过如下方法拿到 Ready channel 。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// raft/node.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token function">Ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> Ready <span class="token punctuation">{</span> <span class="token keyword">return</span> n<span class="token punctuation">.</span>readyc <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>应用需要对 Ready 的处理，在etcdserver/raft.go的start函数有明确指出，包括如下内容：</p> <p>(1) 将 HardState、Entries、Snapshot 持久化到 storage；</p> <p>(2) 将 Messages 非阻塞的广播给其他 peers；</p> <p>(3) 将 CommittedEntries (已经提交但是还没有应用的日志) 应用到状态机；</p> <p>(4) 如果发现 CommittedEntries 中有成员变更类型的 entry，则调用 node 的 ApplyConfChange() 方法让 node 知道；</p> <p>(5) 调用 Node.Advance() 告诉 raft node 这批状态更新处理完，状态已经演进了，可以给我下一批 Ready 让我处理了。</p> <h3 id="_3-5-raft设计"><a href="#_3-5-raft设计" class="header-anchor">#</a> 3.5 Raft设计</h3> <h4 id="_3-5-1-概述"><a href="#_3-5-1-概述" class="header-anchor">#</a> 3.5.1 概述</h4> <p>随着分布式技术的不断发展，单点故障场景下系统异常时有发生。为了解决单点问题，软件系统工程师引入了数据复制技术，实现多副本。而多副本间的数据复制就会出现一致性问题。所以需要共识算法来解决该问题。</p> <p>共识算法(consensus algorithm)的祖师爷是 Paxos， 但是由于它过于复杂，难于理解，工程实践上也较难落地，导致在工程界落地较慢。 Raft 算法作为一种共识算法，正是为了可理解性、易实现而诞生的。</p> <p>raft 会先选举出 leader，leader 完全负责 replicated log 的管理。leader 负责接受所有客户端更新请求，然后复制到 follower 节点，并在“安全”的时候执行这些请求。如果 leader 故障，followes 会重新选举出新的 leader。</p> <p>通过 leader，raft 将一致性问题分解成三个相当独立的子问题：</p> <p>Leader Election：当集群启动或者 leader 失效时必须选出一个新的leader。</p> <p>Log Replication：leader 必须接收客户端提交的日志，并将其复制到集群中的其他节点，强制其他节点的日志与 leader 一样。</p> <p>Safety：最关键的安全点就状态机安全属性(State Machine Safety Property)。如果任何一个 server 已经在它的状态机apply了一条日志，其他的 server 不可能在相同的 index 处 apply 其他不同的日志条目。在Log Replication的实现中有具体体现，就不单独赘述。</p> <p>后面将会详细的讲述具体如何实现。</p> <h4 id="_3-5-2-领导选举"><a href="#_3-5-2-领导选举" class="header-anchor">#</a> 3.5.2 领导选举</h4> <p>在 RAFT 协议实现的代码中，node[raft/node.go] 是其核心的实现，也是整个分布式算法的核心所在。首先在 Raft 协议中它定义了集群中的如下节点状态，任何时刻，每个节点肯定处于其中一个状态：</p> <p>(1) Follower，跟随者， 同步从 Leader 收到的日志，etcd 启动的时候默认为此状态；</p> <p>(2) Candidate，竞选者，可以发起 Leader 选举；</p> <p>(3) Leader，集群领导者， 唯一性，拥有同步日志的特权，需定时广播心跳给 Follower 节点，以维持领导者身份。</p> <p>Raft 协议将时间划分成一个个任期（Term），任期用连续的整数表示，每个任期从一次选举开始，赢得选举的节点在该任期内充当 Leader 的职责，随着时间的消逝，集群可能会发生新的选举，任期号也会单调递增。通过任期号，可以比较各个节点的数据新旧、识别过期的 Leader 等，它在 Raft 算法中充当逻辑时钟，发挥着重要作用。</p> <p>另外，通过 <code>raftNode[etcdserver/raft.go]</code> 对 node 进一步封装，只对 <code>EtcdServer</code> 暴露了 <code>startNode()</code>、<code>start()</code>、<code>apply()</code>、<code>processMessages()</code> 等少数几个接口。就如3.4.3处理流程提到的，其中核心部分是通过 start() 方法启动的一个协程，这里会等待从 <code>readyc</code> 通道上报的数据。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// etcdserver/raft.go</span>
<span class="token comment">// start prepares and starts raftNode in a new goroutine. It is no longer safe</span>
<span class="token comment">// to modify the fields after it has been started.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>raftNode<span class="token punctuation">)</span> <span class="token function">start</span><span class="token punctuation">(</span>rh <span class="token operator">*</span>raftReadyHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	internalTimeout <span class="token operator">:=</span> time<span class="token punctuation">.</span>Second
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">defer</span> r<span class="token punctuation">.</span><span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		islead <span class="token operator">:=</span> <span class="token boolean">false</span>
		<span class="token keyword">for</span> <span class="token punctuation">{</span>
			<span class="token keyword">select</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>r<span class="token punctuation">.</span>ticker<span class="token punctuation">.</span>C<span class="token punctuation">:</span>
				r<span class="token punctuation">.</span><span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">case</span> rd <span class="token operator">:=</span> <span class="token operator">&lt;-</span>r<span class="token punctuation">.</span><span class="token function">Ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
				<span class="token keyword">if</span> rd<span class="token punctuation">.</span>SoftState <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                   <span class="token comment">//申请Leader</span>
					newLeader <span class="token operator">:=</span> rd<span class="token punctuation">.</span>SoftState<span class="token punctuation">.</span>Lead <span class="token operator">!=</span> raft<span class="token punctuation">.</span>None <span class="token operator">&amp;&amp;</span> rh<span class="token punctuation">.</span><span class="token function">getLead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> rd<span class="token punctuation">.</span>SoftState<span class="token punctuation">.</span>Lead
					<span class="token keyword">if</span> newLeader <span class="token punctuation">{</span>
						leaderChanges<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">if</span> rd<span class="token punctuation">.</span>SoftState<span class="token punctuation">.</span>Lead <span class="token operator">==</span> raft<span class="token punctuation">.</span>None <span class="token punctuation">{</span>
						hasLeader<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
					<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
						hasLeader<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
					<span class="token punctuation">}</span>
					rh<span class="token punctuation">.</span><span class="token function">updateLead</span><span class="token punctuation">(</span>rd<span class="token punctuation">.</span>SoftState<span class="token punctuation">.</span>Lead<span class="token punctuation">)</span>
					islead <span class="token operator">=</span> rd<span class="token punctuation">.</span>RaftState <span class="token operator">==</span> raft<span class="token punctuation">.</span>StateLeader
					<span class="token keyword">if</span> islead <span class="token punctuation">{</span>
						isLeader<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
					<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
						isLeader<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
					<span class="token punctuation">}</span>
					rh<span class="token punctuation">.</span><span class="token function">updateLeadership</span><span class="token punctuation">(</span>newLeader<span class="token punctuation">)</span>
					r<span class="token punctuation">.</span>td<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>rd<span class="token punctuation">.</span>ReadStates<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
					<span class="token keyword">select</span> <span class="token punctuation">{</span>
					<span class="token keyword">case</span> r<span class="token punctuation">.</span>readStateC <span class="token operator">&lt;-</span> rd<span class="token punctuation">.</span>ReadStates<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>rd<span class="token punctuation">.</span>ReadStates<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
					<span class="token keyword">case</span> <span class="token operator">&lt;-</span>time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span>internalTimeout<span class="token punctuation">)</span><span class="token punctuation">:</span>
						r<span class="token punctuation">.</span>lg<span class="token punctuation">.</span><span class="token function">Warn</span><span class="token punctuation">(</span><span class="token string">&quot;timed out sending read state&quot;</span><span class="token punctuation">,</span> zap<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span><span class="token string">&quot;timeout&quot;</span><span class="token punctuation">,</span> internalTimeout<span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token keyword">case</span> <span class="token operator">&lt;-</span>r<span class="token punctuation">.</span>stopped<span class="token punctuation">:</span>
						<span class="token keyword">return</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
				notifyc <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
				ap <span class="token operator">:=</span> toApply<span class="token punctuation">{</span>
					entries<span class="token punctuation">:</span>  rd<span class="token punctuation">.</span>CommittedEntries<span class="token punctuation">,</span>
					snapshot<span class="token punctuation">:</span> rd<span class="token punctuation">.</span>Snapshot<span class="token punctuation">,</span>
					notifyc<span class="token punctuation">:</span>  notifyc<span class="token punctuation">,</span>
				<span class="token punctuation">}</span>
				<span class="token function">updateCommittedIndex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ap<span class="token punctuation">,</span> rh<span class="token punctuation">)</span>
				<span class="token keyword">select</span> <span class="token punctuation">{</span>
				<span class="token keyword">case</span> r<span class="token punctuation">.</span>applyc <span class="token operator">&lt;-</span> ap<span class="token punctuation">:</span>
				<span class="token keyword">case</span> <span class="token operator">&lt;-</span>r<span class="token punctuation">.</span>stopped<span class="token punctuation">:</span>
					<span class="token keyword">return</span>
				<span class="token punctuation">}</span>
				<span class="token comment">// the leader can write to its disk in parallel with replicating to the followers and them</span>
				<span class="token comment">// writing to their disks.</span>
				<span class="token comment">// For more details, check raft thesis 10.2.1</span>
				<span class="token keyword">if</span> islead <span class="token punctuation">{</span>
					<span class="token comment">// gofail: var raftBeforeLeaderSend struct{}</span>
					r<span class="token punctuation">.</span>transport<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">processMessages</span><span class="token punctuation">(</span>rd<span class="token punctuation">.</span>Messages<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
				<span class="token comment">// Must save the snapshot file and WAL snapshot entry before saving any other entries or hardstate to</span>
				<span class="token comment">// ensure that recovery after a snapshot restore is possible.</span>
				<span class="token keyword">if</span> <span class="token operator">!</span>raft<span class="token punctuation">.</span><span class="token function">IsEmptySnap</span><span class="token punctuation">(</span>rd<span class="token punctuation">.</span>Snapshot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">// gofail: var raftBeforeSaveSnap struct{}</span>
					<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span>storage<span class="token punctuation">.</span><span class="token function">SaveSnap</span><span class="token punctuation">(</span>rd<span class="token punctuation">.</span>Snapshot<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
						r<span class="token punctuation">.</span>lg<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;failed to save Raft snapshot&quot;</span><span class="token punctuation">,</span> zap<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token punctuation">}</span>
					<span class="token comment">// gofail: var raftAfterSaveSnap struct{}</span>
				<span class="token punctuation">}</span>
				<span class="token comment">// gofail: var raftBeforeSave struct{}</span>
				<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span>storage<span class="token punctuation">.</span><span class="token function">Save</span><span class="token punctuation">(</span>rd<span class="token punctuation">.</span>HardState<span class="token punctuation">,</span> rd<span class="token punctuation">.</span>Entries<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
					r<span class="token punctuation">.</span>lg<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;failed to save Raft hard state and entries&quot;</span><span class="token punctuation">,</span> zap<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> <span class="token operator">!</span>raft<span class="token punctuation">.</span><span class="token function">IsEmptyHardState</span><span class="token punctuation">(</span>rd<span class="token punctuation">.</span>HardState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					proposalsCommitted<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token function">float64</span><span class="token punctuation">(</span>rd<span class="token punctuation">.</span>HardState<span class="token punctuation">.</span>Commit<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
				<span class="token comment">// gofail: var raftAfterSave struct{}</span>
				<span class="token keyword">if</span> <span class="token operator">!</span>raft<span class="token punctuation">.</span><span class="token function">IsEmptySnap</span><span class="token punctuation">(</span>rd<span class="token punctuation">.</span>Snapshot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token comment">// Force WAL to fsync its hard state before Release() releases</span>
					<span class="token comment">// old data from the WAL. Otherwise could get an error like:</span>
					<span class="token comment">// panic: tocommit(107) is out of range [lastIndex(84)]. Was the raft log corrupted, truncated, or lost?</span>
					<span class="token comment">// See https://github.com/etcd-io/etcd/issues/10219 for more details.</span>
					<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span>storage<span class="token punctuation">.</span><span class="token function">Sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
						r<span class="token punctuation">.</span>lg<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;failed to sync Raft snapshot&quot;</span><span class="token punctuation">,</span> zap<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token punctuation">}</span>
					<span class="token comment">// etcdserver now claim the snapshot has been persisted onto the disk</span>
					notifyc <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
					<span class="token comment">// gofail: var raftBeforeApplySnap struct{}</span>
					r<span class="token punctuation">.</span>raftStorage<span class="token punctuation">.</span><span class="token function">ApplySnapshot</span><span class="token punctuation">(</span>rd<span class="token punctuation">.</span>Snapshot<span class="token punctuation">)</span>
					r<span class="token punctuation">.</span>lg<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">&quot;applied incoming Raft snapshot&quot;</span><span class="token punctuation">,</span> zap<span class="token punctuation">.</span><span class="token function">Uint64</span><span class="token punctuation">(</span><span class="token string">&quot;snapshot-index&quot;</span><span class="token punctuation">,</span> rd<span class="token punctuation">.</span>Snapshot<span class="token punctuation">.</span>Metadata<span class="token punctuation">.</span>Index<span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token comment">// gofail: var raftAfterApplySnap struct{}</span>
					<span class="token keyword">if</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span>storage<span class="token punctuation">.</span><span class="token function">Release</span><span class="token punctuation">(</span>rd<span class="token punctuation">.</span>Snapshot<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
						r<span class="token punctuation">.</span>lg<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span><span class="token string">&quot;failed to release Raft wal&quot;</span><span class="token punctuation">,</span> zap<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token punctuation">}</span>
					<span class="token comment">// gofail: var raftAfterWALRelease struct{}</span>
				<span class="token punctuation">}</span>
				r<span class="token punctuation">.</span>raftStorage<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>rd<span class="token punctuation">.</span>Entries<span class="token punctuation">)</span>
				<span class="token keyword">if</span> <span class="token operator">!</span>islead <span class="token punctuation">{</span>
					<span class="token comment">// finish processing incoming messages before we signal raftdone chan</span>
					msgs <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">processMessages</span><span class="token punctuation">(</span>rd<span class="token punctuation">.</span>Messages<span class="token punctuation">)</span>
					<span class="token comment">// now unblocks 'applyAll' that waits on Raft log disk writes before triggering snapshots</span>
					notifyc <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
					<span class="token comment">// Candidate or follower needs to wait for all pending configuration</span>
					<span class="token comment">// changes to be applied before sending messages.</span>
					<span class="token comment">// Otherwise we might incorrectly count votes (e.g. votes from removed members).</span>
					<span class="token comment">// Also slow machine's follower raft-layer could proceed to become the leader</span>
					<span class="token comment">// on its own single-node cluster, before toApply-layer applies the config change.</span>
					<span class="token comment">// We simply wait for ALL pending entries to be applied for now.</span>
					<span class="token comment">// We might improve this later on if it causes unnecessary long blocking issues.</span>
					waitApply <span class="token operator">:=</span> <span class="token boolean">false</span>
					<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ent <span class="token operator">:=</span> <span class="token keyword">range</span> rd<span class="token punctuation">.</span>CommittedEntries <span class="token punctuation">{</span>
						<span class="token keyword">if</span> ent<span class="token punctuation">.</span>Type <span class="token operator">==</span> raftpb<span class="token punctuation">.</span>EntryConfChange <span class="token punctuation">{</span>
							waitApply <span class="token operator">=</span> <span class="token boolean">true</span>
							<span class="token keyword">break</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
					<span class="token keyword">if</span> waitApply <span class="token punctuation">{</span>
						<span class="token comment">// blocks until 'applyAll' calls 'applyWait.Trigger'</span>
						<span class="token comment">// to be in sync with scheduled config-change job</span>
						<span class="token comment">// (assume notifyc has cap of 1)</span>
						<span class="token keyword">select</span> <span class="token punctuation">{</span>
						<span class="token keyword">case</span> notifyc <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">:</span>
						<span class="token keyword">case</span> <span class="token operator">&lt;-</span>r<span class="token punctuation">.</span>stopped<span class="token punctuation">:</span>
							<span class="token keyword">return</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
					<span class="token comment">// gofail: var raftBeforeFollowerSend struct{}</span>
					r<span class="token punctuation">.</span>transport<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>msgs<span class="token punctuation">)</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					<span class="token comment">// leader already processed 'MsgSnap' and signaled</span>
					notifyc <span class="token operator">&lt;-</span> <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
				r<span class="token punctuation">.</span><span class="token function">Advance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>r<span class="token punctuation">.</span>stopped<span class="token punctuation">:</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br></div></div><p>接下来，我们再回过头来看一下3.4.3小节提到的后台启动程序<code>node.run()</code>，具体代码如下：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// raft/node.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token operator">...</span>
		<span class="token keyword">select</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> pm <span class="token operator">:=</span> <span class="token operator">&lt;-</span>propc<span class="token punctuation">:</span>
			<span class="token operator">...</span>
			r<span class="token punctuation">.</span><span class="token function">Step</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
		<span class="token keyword">case</span> m <span class="token operator">:=</span> <span class="token operator">&lt;-</span>n<span class="token punctuation">.</span>recvc<span class="token punctuation">:</span>
			<span class="token operator">...</span>
			r<span class="token punctuation">.</span><span class="token function">Step</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
		<span class="token keyword">case</span> cc <span class="token operator">:=</span> <span class="token operator">&lt;-</span>n<span class="token punctuation">.</span>confc<span class="token punctuation">:</span>
			<span class="token operator">...</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>n<span class="token punctuation">.</span>tickc<span class="token punctuation">:</span>
			n<span class="token punctuation">.</span>rn<span class="token punctuation">.</span><span class="token function">Tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">case</span> readyc <span class="token operator">&lt;-</span> rd<span class="token punctuation">:</span>
			n<span class="token punctuation">.</span>rn<span class="token punctuation">.</span><span class="token function">acceptReady</span><span class="token punctuation">(</span>rd<span class="token punctuation">)</span>
			advancec <span class="token operator">=</span> n<span class="token punctuation">.</span>advancec
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>advancec<span class="token punctuation">:</span>
			n<span class="token punctuation">.</span>rn<span class="token punctuation">.</span><span class="token function">Advance</span><span class="token punctuation">(</span>rd<span class="token punctuation">)</span>
			rd <span class="token operator">=</span> Ready<span class="token punctuation">{</span><span class="token punctuation">}</span>
			advancec <span class="token operator">=</span> <span class="token boolean">nil</span>
		<span class="token keyword">case</span> c <span class="token operator">:=</span> <span class="token operator">&lt;-</span>n<span class="token punctuation">.</span>status<span class="token punctuation">:</span>
			c <span class="token operator">&lt;-</span> <span class="token function">getStatus</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
		<span class="token keyword">case</span> <span class="token operator">&lt;-</span>n<span class="token punctuation">.</span>stop<span class="token punctuation">:</span>
			<span class="token function">close</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>done<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>主要是通过for-select-channel监听channel信息，来处理不同的请求。下面来看下几个主要的channel信息</p> <p>propc和recvc中拿到的是从上层应用传进来的消息，这个消息会被交给raft层的Step函数处理。Step是etcd-raft模块负责各类信息的入口，其中default后面的step，被实现为一个状态机，它的step属性是一个函数指针，根据当前节点的不同角色，指向不同的消息处理函数：<code>stepLeader</code>/<code>stepFollower</code>/<code>stepCandidate</code>。与它类似的还有一个<code>tick</code>函数指针，根据角色的不同，也会在<code>tickHeartbeat</code>和<code>tickElection</code>之间来回切换，分别用来触发定时心跳和选举检测。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>raft<span class="token punctuation">)</span> <span class="token function">Step</span><span class="token punctuation">(</span>m pb<span class="token punctuation">.</span>Message<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token comment">//...</span>
	<span class="token keyword">switch</span> m<span class="token punctuation">.</span>Type <span class="token punctuation">{</span>
	<span class="token keyword">case</span> pb<span class="token punctuation">.</span>MsgHup<span class="token punctuation">:</span>
	<span class="token comment">//...</span>
	<span class="token keyword">case</span> pb<span class="token punctuation">.</span>MsgVote<span class="token punctuation">,</span> pb<span class="token punctuation">.</span>MsgPreVote<span class="token punctuation">:</span>
	<span class="token comment">//...</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		r<span class="token punctuation">.</span><span class="token function">step</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> m<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>(1)  作为leader</p> <p>当一个节点成为leader的时候，会将节点的定时器设置为tickHeartbeat，然后周期性的调用，维持leader的地位。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// raft/raft.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>raft<span class="token punctuation">)</span> <span class="token function">becomeLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 检测当 前节点的状态，禁止从 follower 状态切换成 leader 状态</span>
	<span class="token keyword">if</span> r<span class="token punctuation">.</span>state <span class="token operator">==</span> StateFollower <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;invalid transition [follower -&gt; leader]&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 将step 字段设置成 stepLeader</span>
	r<span class="token punctuation">.</span>step <span class="token operator">=</span> stepLeader
	r<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Term<span class="token punctuation">)</span>
	<span class="token comment">// 设置心跳的函数</span>
	r<span class="token punctuation">.</span>tick <span class="token operator">=</span> r<span class="token punctuation">.</span>tickHeartbeat
	<span class="token comment">// 设置lead的id值</span>
	r<span class="token punctuation">.</span>lead <span class="token operator">=</span> r<span class="token punctuation">.</span>id
	<span class="token comment">// 更新当前的角色</span>
	r<span class="token punctuation">.</span>state <span class="token operator">=</span> StateLeader
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
<span class="token comment">// raft/raft.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>raft<span class="token punctuation">)</span> <span class="token function">tickHeartbeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 递增心跳计数器</span>
	r<span class="token punctuation">.</span>heartbeatElapsed<span class="token operator">++</span>
	<span class="token comment">// 递增选举计数器</span>
	r<span class="token punctuation">.</span>electionElapsed<span class="token operator">++</span>
	<span class="token operator">...</span>
	<span class="token keyword">if</span> r<span class="token punctuation">.</span>electionElapsed <span class="token operator">&gt;=</span> r<span class="token punctuation">.</span>electionTimeout <span class="token punctuation">{</span>
		r<span class="token punctuation">.</span>electionElapsed <span class="token operator">=</span> <span class="token number">0</span>
		<span class="token comment">// 检测当前节点时候大多数节点保持连通</span>
		<span class="token keyword">if</span> r<span class="token punctuation">.</span>checkQuorum <span class="token punctuation">{</span>
			r<span class="token punctuation">.</span><span class="token function">Step</span><span class="token punctuation">(</span>pb<span class="token punctuation">.</span>Message<span class="token punctuation">{</span>From<span class="token punctuation">:</span> r<span class="token punctuation">.</span>id<span class="token punctuation">,</span> Type<span class="token punctuation">:</span> pb<span class="token punctuation">.</span>MsgCheckQuorum<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// If current leader cannot transfer leadership in electionTimeout, it becomes leader again.</span>
		<span class="token keyword">if</span> r<span class="token punctuation">.</span>state <span class="token operator">==</span> StateLeader <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>leadTransferee <span class="token operator">!=</span> None <span class="token punctuation">{</span>
			r<span class="token punctuation">.</span><span class="token function">abortLeaderTransfer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> r<span class="token punctuation">.</span>heartbeatElapsed <span class="token operator">&gt;=</span> r<span class="token punctuation">.</span>heartbeatTimeout <span class="token punctuation">{</span>
		r<span class="token punctuation">.</span>heartbeatElapsed <span class="token operator">=</span> <span class="token number">0</span>
		r<span class="token punctuation">.</span><span class="token function">Step</span><span class="token punctuation">(</span>pb<span class="token punctuation">.</span>Message<span class="token punctuation">{</span>From<span class="token punctuation">:</span> r<span class="token punctuation">.</span>id<span class="token punctuation">,</span> Type<span class="token punctuation">:</span> pb<span class="token punctuation">.</span>MsgBeat<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>becomeLeader中的step被设置成stepLeader，所以将会调用stepLeader来处理leader中对应的消息，并通过调用raft.bcastHeartbeat()向所有的节点发送心跳。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">stepLeader</span><span class="token punctuation">(</span>r <span class="token operator">*</span>raft<span class="token punctuation">,</span> m pb<span class="token punctuation">.</span>Message<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token comment">// These message types do not require any progress for m.From.</span>
	<span class="token keyword">switch</span> m<span class="token punctuation">.</span>Type <span class="token punctuation">{</span>
	<span class="token keyword">case</span> pb<span class="token punctuation">.</span>MsgBeat<span class="token punctuation">:</span>
		<span class="token comment">// 向所有节点发送心跳</span>
		r<span class="token punctuation">.</span><span class="token function">bcastHeartbeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token keyword">case</span> pb<span class="token punctuation">.</span>MsgCheckQuorum<span class="token punctuation">:</span>
		<span class="token comment">// 检测是否和大部分节点保持连通</span>
		<span class="token comment">// 如果不连通切换到follower状态</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>r<span class="token punctuation">.</span>prs<span class="token punctuation">.</span><span class="token function">QuorumActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			r<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">Warningf</span><span class="token punctuation">(</span><span class="token string">&quot;%x stepped down to follower since quorum is not active&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
			r<span class="token punctuation">.</span><span class="token function">becomeFollower</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Term<span class="token punctuation">,</span> None<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token operator">...</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// bcastHeartbeat sends RPC, without entries to all the peers.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>raft<span class="token punctuation">)</span> <span class="token function">bcastHeartbeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	lastCtx <span class="token operator">:=</span> r<span class="token punctuation">.</span>readOnly<span class="token punctuation">.</span><span class="token function">lastPendingRequestCtx</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 这两个函数最终都将调用sendHeartbeat</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>lastCtx<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		r<span class="token punctuation">.</span><span class="token function">bcastHeartbeatWithCtx</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		r<span class="token punctuation">.</span><span class="token function">bcastHeartbeatWithCtx</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>lastCtx<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 向指定的节点发送信息</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>raft<span class="token punctuation">)</span> <span class="token function">sendHeartbeat</span><span class="token punctuation">(</span>to <span class="token builtin">uint64</span><span class="token punctuation">,</span> ctx <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	commit <span class="token operator">:=</span> <span class="token function">min</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>prs<span class="token punctuation">.</span>Progress<span class="token punctuation">[</span>to<span class="token punctuation">]</span><span class="token punctuation">.</span>Match<span class="token punctuation">,</span> r<span class="token punctuation">.</span>raftLog<span class="token punctuation">.</span>committed<span class="token punctuation">)</span>
	m <span class="token operator">:=</span> pb<span class="token punctuation">.</span>Message<span class="token punctuation">{</span>
		To<span class="token punctuation">:</span>      to<span class="token punctuation">,</span>
		<span class="token comment">// 发送MsgHeartbeat类型的数据</span>
		Type<span class="token punctuation">:</span>    pb<span class="token punctuation">.</span>MsgHeartbeat<span class="token punctuation">,</span>
		Commit<span class="token punctuation">:</span>  commit<span class="token punctuation">,</span>
		Context<span class="token punctuation">:</span> ctx<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
	r<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>最终的心跳通过MsgHeartbeat的消息类型进行发送，通知它们目前Leader的存活状态，重置所有Follower持有的超时计时器</p> <p>(2) 作为follower</p> <p>在step函数中将实现如下功能：接收到来自leader的RPC消息MsgHeartbeat，然后重置当前节点的选举超时时间，回复leader自己的存活。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">stepFollower</span><span class="token punctuation">(</span>r <span class="token operator">*</span>raft<span class="token punctuation">,</span> m pb<span class="token punctuation">.</span>Message<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> m<span class="token punctuation">.</span>Type <span class="token punctuation">{</span>
	<span class="token keyword">case</span> pb<span class="token punctuation">.</span>MsgProp<span class="token punctuation">:</span>
		<span class="token operator">...</span>
	<span class="token keyword">case</span> pb<span class="token punctuation">.</span>MsgHeartbeat<span class="token punctuation">:</span>
		r<span class="token punctuation">.</span>electionElapsed <span class="token operator">=</span> <span class="token number">0</span>
		r<span class="token punctuation">.</span>lead <span class="token operator">=</span> m<span class="token punctuation">.</span>From
		r<span class="token punctuation">.</span><span class="token function">handleHeartbeat</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
		<span class="token operator">...</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>raft<span class="token punctuation">)</span> <span class="token function">handleHeartbeat</span><span class="token punctuation">(</span>m pb<span class="token punctuation">.</span>Message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r<span class="token punctuation">.</span>raftLog<span class="token punctuation">.</span><span class="token function">commitTo</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Commit<span class="token punctuation">)</span>
	r<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>pb<span class="token punctuation">.</span>Message<span class="token punctuation">{</span>To<span class="token punctuation">:</span> m<span class="token punctuation">.</span>From<span class="token punctuation">,</span> Type<span class="token punctuation">:</span> pb<span class="token punctuation">.</span>MsgHeartbeatResp<span class="token punctuation">,</span> Context<span class="token punctuation">:</span> m<span class="token punctuation">.</span>Context<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>(3) 作为Candidate</p> <p>candidate来处理MsgHeartbeat的信息，是先把自己变成follower，然后和上面的follower一样，回复leader自己的存活。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">stepCandidate</span><span class="token punctuation">(</span>r <span class="token operator">*</span>raft<span class="token punctuation">,</span> m pb<span class="token punctuation">.</span>Message<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	<span class="token keyword">switch</span> m<span class="token punctuation">.</span>Type <span class="token punctuation">{</span>
		<span class="token operator">...</span>
	<span class="token keyword">case</span> pb<span class="token punctuation">.</span>MsgHeartbeat<span class="token punctuation">:</span>
		r<span class="token punctuation">.</span><span class="token function">becomeFollower</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Term<span class="token punctuation">,</span> m<span class="token punctuation">.</span>From<span class="token punctuation">)</span> <span class="token comment">// always m.Term == r.Term</span>
		r<span class="token punctuation">.</span><span class="token function">handleHeartbeat</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token operator">...</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>raft<span class="token punctuation">)</span> <span class="token function">handleHeartbeat</span><span class="token punctuation">(</span>m pb<span class="token punctuation">.</span>Message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r<span class="token punctuation">.</span>raftLog<span class="token punctuation">.</span><span class="token function">commitTo</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Commit<span class="token punctuation">)</span>
	r<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>pb<span class="token punctuation">.</span>Message<span class="token punctuation">{</span>To<span class="token punctuation">:</span> m<span class="token punctuation">.</span>From<span class="token punctuation">,</span> Type<span class="token punctuation">:</span> pb<span class="token punctuation">.</span>MsgHeartbeatResp<span class="token punctuation">,</span> Context<span class="token punctuation">:</span> m<span class="token punctuation">.</span>Context<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>当leader收到返回的信息的时候，会将对应的节点设置为RecentActive，表示该节点目前存活。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">stepLeader</span><span class="token punctuation">(</span>r <span class="token operator">*</span>raft<span class="token punctuation">,</span> m pb<span class="token punctuation">.</span>Message<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	<span class="token comment">// 根据from，取出当前的follower的Progress</span>
	pr <span class="token operator">:=</span> r<span class="token punctuation">.</span>prs<span class="token punctuation">.</span>Progress<span class="token punctuation">[</span>m<span class="token punctuation">.</span>From<span class="token punctuation">]</span>
	<span class="token keyword">if</span> pr <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		r<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">Debugf</span><span class="token punctuation">(</span><span class="token string">&quot;%x no progress available for %x&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>id<span class="token punctuation">,</span> m<span class="token punctuation">.</span>From<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">switch</span> m<span class="token punctuation">.</span>Type <span class="token punctuation">{</span>
	<span class="token keyword">case</span> pb<span class="token punctuation">.</span>MsgHeartbeatResp<span class="token punctuation">:</span>
		pr<span class="token punctuation">.</span>RecentActive <span class="token operator">=</span> <span class="token boolean">true</span>
		<span class="token operator">...</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>当 Follower 节点接收 Leader 节点心跳消息超时后，它会转变成 Candidate 节点，并可发起新一轮的竞选 Leader 投票，若获得集群多数节点的支持后，它就可转变成 Leader 节点。</p> <p>在Step函数中，我们可以看到MsgHup这个消息后会调用campaign函数，进入竞选状态。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// raft/raft.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>raft<span class="token punctuation">)</span> <span class="token function">Step</span><span class="token punctuation">(</span>m pb<span class="token punctuation">.</span>Message<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token comment">//...</span>
	<span class="token keyword">switch</span> m<span class="token punctuation">.</span>Type <span class="token punctuation">{</span>
	<span class="token keyword">case</span> pb<span class="token punctuation">.</span>MsgHup<span class="token punctuation">:</span>
		<span class="token keyword">if</span> r<span class="token punctuation">.</span>preVote <span class="token punctuation">{</span>
			r<span class="token punctuation">.</span><span class="token function">hup</span><span class="token punctuation">(</span>campaignPreElection<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			r<span class="token punctuation">.</span><span class="token function">hup</span><span class="token punctuation">(</span>campaignElection<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>raft<span class="token punctuation">)</span> <span class="token function">hup</span><span class="token punctuation">(</span>t CampaignType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	r<span class="token punctuation">.</span><span class="token function">campaign</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>raft<span class="token punctuation">)</span> <span class="token function">campaign</span><span class="token punctuation">(</span>t CampaignType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	<span class="token keyword">if</span> t <span class="token operator">==</span> campaignPreElection <span class="token punctuation">{</span>
		r<span class="token punctuation">.</span><span class="token function">becomePreCandidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		voteMsg <span class="token operator">=</span> pb<span class="token punctuation">.</span>MsgPreVote
		<span class="token comment">// PreVote RPCs are sent for the next term before we've incremented r.Term.</span>
		term <span class="token operator">=</span> r<span class="token punctuation">.</span>Term <span class="token operator">+</span> <span class="token number">1</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token comment">// 切换到Candidate状态</span>
		r<span class="token punctuation">.</span><span class="token function">becomeCandidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		voteMsg <span class="token operator">=</span> pb<span class="token punctuation">.</span>MsgVote
		term <span class="token operator">=</span> r<span class="token punctuation">.</span>Term
	<span class="token punctuation">}</span>
	<span class="token comment">// 统计当前节点收到的选票 并统计其得票数是否超过半数，这次检测主要是为单节点设置的</span>
	<span class="token comment">// 判断是否是单节点</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> res <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token function">voteRespMsgType</span><span class="token punctuation">(</span>voteMsg<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> res <span class="token operator">==</span> quorum<span class="token punctuation">.</span>VoteWon <span class="token punctuation">{</span>
		<span class="token keyword">if</span> t <span class="token operator">==</span> campaignPreElection <span class="token punctuation">{</span>
			r<span class="token punctuation">.</span><span class="token function">campaign</span><span class="token punctuation">(</span>campaignElection<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token comment">// 是单节点直接，变成leader</span>
			r<span class="token punctuation">.</span><span class="token function">becomeLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token operator">...</span>
	<span class="token comment">// 向集群中的所有节点发送信息，请求投票</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> id <span class="token operator">:=</span> <span class="token keyword">range</span> ids <span class="token punctuation">{</span>
		<span class="token comment">// 跳过自身的节点</span>
		<span class="token keyword">if</span> id <span class="token operator">==</span> r<span class="token punctuation">.</span>id <span class="token punctuation">{</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		r<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;%x [logterm: %d, index: %d] sent %s request to %x at term %d&quot;</span><span class="token punctuation">,</span>
			r<span class="token punctuation">.</span>id<span class="token punctuation">,</span> r<span class="token punctuation">.</span>raftLog<span class="token punctuation">.</span><span class="token function">lastTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>raftLog<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> voteMsg<span class="token punctuation">,</span> id<span class="token punctuation">,</span> r<span class="token punctuation">.</span>Term<span class="token punctuation">)</span>
		<span class="token keyword">var</span> ctx <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
		<span class="token keyword">if</span> t <span class="token operator">==</span> campaignTransfer <span class="token punctuation">{</span>
			ctx <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		r<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>pb<span class="token punctuation">.</span>Message<span class="token punctuation">{</span>Term<span class="token punctuation">:</span> term<span class="token punctuation">,</span> To<span class="token punctuation">:</span> id<span class="token punctuation">,</span> Type<span class="token punctuation">:</span> voteMsg<span class="token punctuation">,</span> Index<span class="token punctuation">:</span> r<span class="token punctuation">.</span>raftLog<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> LogTerm<span class="token punctuation">:</span> r<span class="token punctuation">.</span>raftLog<span class="token punctuation">.</span><span class="token function">lastTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Context<span class="token punctuation">:</span> ctx<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><p>竞选者切换到campaign状态，然后将自己的term信息发送出去，请求投票。这里，我们能看到对于Candidate会有一个PreCandidate，reCandidate这个状态的作用的是：</p> <p>当系统曾出现分区，分区消失后恢复的时候，可能会造成某个被split的Follower的Term数值很大，对服务器进行分区时，它将不会收到heartbeat包，每次electionTimeout后成为Candidate都会递增Term，当服务器在一段时间后恢复连接时，Term的值将会变得很大，然后引入的重新选举会导致临时的延迟与可用性问题。而PreElection阶段并不会真正增加当前节点的Term，它的主要作用是得到当前集群能否成功选举出一个Leader的答案，避免上面这种情况的发生。</p> <p>我们接着Candidate的状态来分析：对于能够投票的成员需要满足下面条件：</p> <p>1、当前节点没有给任何节点投票或投票的节点term大于本节点的或者是之前已经投票的节点；</p> <p>2、该节点的消息是最新的；</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>raft<span class="token punctuation">)</span> <span class="token function">Step</span><span class="token punctuation">(</span>m pb<span class="token punctuation">.</span>Message<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	<span class="token keyword">switch</span> m<span class="token punctuation">.</span>Type <span class="token punctuation">{</span>
	<span class="token keyword">case</span> pb<span class="token punctuation">.</span>MsgVote<span class="token punctuation">,</span> pb<span class="token punctuation">.</span>MsgPreVote<span class="token punctuation">:</span>
		<span class="token comment">// We can vote if this is a repeat of a vote we've already cast...</span>
		canVote <span class="token operator">:=</span> r<span class="token punctuation">.</span>Vote <span class="token operator">==</span> m<span class="token punctuation">.</span>From <span class="token operator">||</span>
			<span class="token comment">// ...we haven't voted and we don't think there's a leader yet in this term...</span>
			<span class="token punctuation">(</span>r<span class="token punctuation">.</span>Vote <span class="token operator">==</span> None <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>lead <span class="token operator">==</span> None<span class="token punctuation">)</span> <span class="token operator">||</span>
			<span class="token comment">// ...or this is a PreVote for a future term...</span>
			<span class="token punctuation">(</span>m<span class="token punctuation">.</span>Type <span class="token operator">==</span> pb<span class="token punctuation">.</span>MsgPreVote <span class="token operator">&amp;&amp;</span> m<span class="token punctuation">.</span>Term <span class="token operator">&gt;</span> r<span class="token punctuation">.</span>Term<span class="token punctuation">)</span>
		<span class="token comment">// ...and we believe the candidate is up to date.</span>
		<span class="token keyword">if</span> canVote <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>raftLog<span class="token punctuation">.</span><span class="token function">isUpToDate</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Index<span class="token punctuation">,</span> m<span class="token punctuation">.</span>LogTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// 如果当前没有给任何节点投票（r.Vote == None）或者投票的节点term大于本节点的（m.Term &gt; r.Term）</span>
			<span class="token comment">// 或者是之前已经投票的节点（r.Vote == m.From）</span>
			<span class="token comment">// 同时还满足该节点的消息是最新的（r.raftLog.isUpToDate(m.Index, m.LogTerm)），那么就接收这个节点的投票</span>
			r<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;%x [logterm: %d, index: %d, vote: %x] cast %s for %x [logterm: %d, index: %d] at term %d&quot;</span><span class="token punctuation">,</span>
				r<span class="token punctuation">.</span>id<span class="token punctuation">,</span> r<span class="token punctuation">.</span>raftLog<span class="token punctuation">.</span><span class="token function">lastTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>raftLog<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Vote<span class="token punctuation">,</span> m<span class="token punctuation">.</span>Type<span class="token punctuation">,</span> m<span class="token punctuation">.</span>From<span class="token punctuation">,</span> m<span class="token punctuation">.</span>LogTerm<span class="token punctuation">,</span> m<span class="token punctuation">.</span>Index<span class="token punctuation">,</span> r<span class="token punctuation">.</span>Term<span class="token punctuation">)</span>
			r<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>pb<span class="token punctuation">.</span>Message<span class="token punctuation">{</span>To<span class="token punctuation">:</span> m<span class="token punctuation">.</span>From<span class="token punctuation">,</span> Term<span class="token punctuation">:</span> m<span class="token punctuation">.</span>Term<span class="token punctuation">,</span> Type<span class="token punctuation">:</span> <span class="token function">voteRespMsgType</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Type<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> m<span class="token punctuation">.</span>Type <span class="token operator">==</span> pb<span class="token punctuation">.</span>MsgVote <span class="token punctuation">{</span>
				<span class="token comment">// 保存下来给哪个节点投票了</span>
				r<span class="token punctuation">.</span>electionElapsed <span class="token operator">=</span> <span class="token number">0</span>
				r<span class="token punctuation">.</span>Vote <span class="token operator">=</span> m<span class="token punctuation">.</span>From
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			r<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;%x [logterm: %d, index: %d, vote: %x] rejected %s from %x [logterm: %d, index: %d] at term %d&quot;</span><span class="token punctuation">,</span>
				r<span class="token punctuation">.</span>id<span class="token punctuation">,</span> r<span class="token punctuation">.</span>raftLog<span class="token punctuation">.</span><span class="token function">lastTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>raftLog<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>Vote<span class="token punctuation">,</span> m<span class="token punctuation">.</span>Type<span class="token punctuation">,</span> m<span class="token punctuation">.</span>From<span class="token punctuation">,</span> m<span class="token punctuation">.</span>LogTerm<span class="token punctuation">,</span> m<span class="token punctuation">.</span>Index<span class="token punctuation">,</span> r<span class="token punctuation">.</span>Term<span class="token punctuation">)</span>
			r<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>pb<span class="token punctuation">.</span>Message<span class="token punctuation">{</span>To<span class="token punctuation">:</span> m<span class="token punctuation">.</span>From<span class="token punctuation">,</span> Term<span class="token punctuation">:</span> r<span class="token punctuation">.</span>Term<span class="token punctuation">,</span> Type<span class="token punctuation">:</span> <span class="token function">voteRespMsgType</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Type<span class="token punctuation">)</span><span class="token punctuation">,</span> Reject<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token operator">...</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>然后，candidate节点接收到投票的信息，并统计投票的数量：</p> <p>1、如果投票数大于节点数的一半的预置，成为leader；</p> <p>2、如果达不到设定预置，变成follower；</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">stepCandidate</span><span class="token punctuation">(</span>r <span class="token operator">*</span>raft<span class="token punctuation">,</span> m pb<span class="token punctuation">.</span>Message<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token comment">// Only handle vote responses corresponding to our candidacy (while in</span>
	<span class="token comment">// StateCandidate, we may get stale MsgPreVoteResp messages in this term from</span>
	<span class="token comment">// our pre-candidate state).</span>
	<span class="token keyword">var</span> myVoteRespType pb<span class="token punctuation">.</span>MessageType
	<span class="token keyword">if</span> r<span class="token punctuation">.</span>state <span class="token operator">==</span> StatePreCandidate <span class="token punctuation">{</span>
		myVoteRespType <span class="token operator">=</span> pb<span class="token punctuation">.</span>MsgPreVoteResp
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		myVoteRespType <span class="token operator">=</span> pb<span class="token punctuation">.</span>MsgVoteResp
	<span class="token punctuation">}</span>
	<span class="token keyword">switch</span> m<span class="token punctuation">.</span>Type <span class="token punctuation">{</span>
	<span class="token keyword">case</span> myVoteRespType<span class="token punctuation">:</span>
		<span class="token comment">// 计算当前集群中有多少节点给自己投了票</span>
		gr<span class="token punctuation">,</span> rj<span class="token punctuation">,</span> res <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>From<span class="token punctuation">,</span> m<span class="token punctuation">.</span>Type<span class="token punctuation">,</span> <span class="token operator">!</span>m<span class="token punctuation">.</span>Reject<span class="token punctuation">)</span>
		r<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;%x has received %d %s votes and %d vote rejections&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>id<span class="token punctuation">,</span> gr<span class="token punctuation">,</span> m<span class="token punctuation">.</span>Type<span class="token punctuation">,</span> rj<span class="token punctuation">)</span>
		<span class="token keyword">switch</span> res <span class="token punctuation">{</span>
		<span class="token comment">// 大多数投票了</span>
		<span class="token keyword">case</span> quorum<span class="token punctuation">.</span>VoteWon<span class="token punctuation">:</span>
			<span class="token keyword">if</span> r<span class="token punctuation">.</span>state <span class="token operator">==</span> StatePreCandidate <span class="token punctuation">{</span>
				r<span class="token punctuation">.</span><span class="token function">campaign</span><span class="token punctuation">(</span>campaignElection<span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token comment">// 如果进行投票的节点数量正好是半数以上节点数量</span>
				r<span class="token punctuation">.</span><span class="token function">becomeLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token comment">// 向集群中其他节点广 MsgApp 消息</span>
				r<span class="token punctuation">.</span><span class="token function">bcastAppend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token comment">// 票数不够</span>
		<span class="token keyword">case</span> quorum<span class="token punctuation">.</span>VoteLost<span class="token punctuation">:</span>
			<span class="token comment">// pb.MsgPreVoteResp contains future term of pre-candidate</span>
			<span class="token comment">// m.Term &gt; r.Term; reuse r.Term</span>
			<span class="token comment">// 切换到follower</span>
			r<span class="token punctuation">.</span><span class="token function">becomeFollower</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Term<span class="token punctuation">,</span> None<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token operator">...</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>每当收到一个MsgVoteResp类型的消息时，就会设置当前节点持有的votes数组，更新其中存储的节点投票状态，如果收到大多数的节点票数，切换成leader，向其他的节点发送当前节点当选的消息，通知其余节点更新Raft结构体中的Term等信息。</p> <h4 id="_3-5-3-日志复制"><a href="#_3-5-3-日志复制" class="header-anchor">#</a> 3.5.3 日志复制</h4> <p>在etcd中，所有数据的修改在提交前，都要先写入到WAL中。WAL（Write Ahead Log）是数据库中保证数据持久化的常用技术，即每次真正操作数据之前，先往磁盘上追加一条日志，由于日志是追加的，也就是顺序写，而不是随机写，所以写入性能还是很高的。这样做的目的是，记录了整个数据变化的全部历程</p> <p>并且使用WAL进行数据的存储使得etcd拥有两个重要功能：</p> <p>(1) 故障快速恢复： 当你的数据遭到破坏时，就可以通过执行所有WAL中记录的修改操作，快速从最原始的数据恢复到数据损坏前的状态。</p> <p>(2) 数据回滚（undo）/重做（redo）：因为所有的修改操作都被记录在WAL中，需要回滚或重做，只需要反向或正向执行日志中的操作即可。</p> <p>在介绍Raft实现之前，我们先来简单概述一下WAL的基础使用。WAL对象定义如下：</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// server/storage/wal/wal.go</span>
<span class="token comment">// WAL这个抽象的结构体是由一堆的文件组成的</span>
<span class="token comment">// 每个WAL文件的头部有一部分数据，是metadata，使用 w.Save 保存数据</span>
<span class="token comment">// 使用完成之后，使用 w.Close 关闭</span>
<span class="token comment">// WAL中的每一条记录，都有一个循环冗余校验码（CRC）</span>
<span class="token comment">// WAL是只能打开来用于读，或者写，但是不能既读又写</span>
<span class="token keyword">type</span> WAL <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	lg <span class="token operator">*</span>zap<span class="token punctuation">.</span>Logger
	dir <span class="token builtin">string</span> <span class="token comment">// the living directory of the underlay files</span>
	<span class="token comment">// dirFile is a fd for the wal directory for syncing on Rename</span>
	dirFile <span class="token operator">*</span>os<span class="token punctuation">.</span>File
	metadata <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>           <span class="token comment">// metadata recorded at the head of each WAL</span>
	state    raftpb<span class="token punctuation">.</span>HardState <span class="token comment">// hardstate recorded at the head of WAL</span>
	start     walpb<span class="token punctuation">.</span>Snapshot <span class="token comment">// snapshot to start reading</span>
	decoder   <span class="token operator">*</span>decoder       <span class="token comment">// decoder to decode records</span>
	readClose <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span>   <span class="token comment">// closer for decode reader</span>
	unsafeNoSync <span class="token builtin">bool</span> <span class="token comment">// if set, do not fsync</span>
	mu      sync<span class="token punctuation">.</span>Mutex
	enti    <span class="token builtin">uint64</span>   <span class="token comment">// index of the last entry saved to the wal</span>
	encoder <span class="token operator">*</span>encoder <span class="token comment">// encoder to encode records</span>
	locks <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>fileutil<span class="token punctuation">.</span>LockedFile <span class="token comment">// the locked files the WAL holds (the name is increasing)</span>
	fp    <span class="token operator">*</span>figolePipeline
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>在Save函数中，就是写入一条记录，然后调用 w.sync，而 w.sync 做的事情就是：调用了 fileutil.Fdatasync，而 fileutil.Fdatasync 就是调用了 fsync 这个系统调用保证数据会被写到磁盘。而快照也是类似的，写入一条记录，然后同步。</p> <p>回归正题，在 RAFT 协议中，整个集群所有变更都必须通过 Leader 发起，如下其入口为 node.Propose ()，而日志的保存总体流程如下：</p> <p>(1) 集群某个节点收到client的put请求要求修改数据。节点会生成一个Type为MsgProp的Message，发送给leader。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// 生成MsgProp消息</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>n <span class="token operator">*</span>node<span class="token punctuation">)</span> <span class="token function">Propose</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> n<span class="token punctuation">.</span><span class="token function">stepWait</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> pb<span class="token punctuation">.</span>Message<span class="token punctuation">{</span>Type<span class="token punctuation">:</span> pb<span class="token punctuation">.</span>MsgProp<span class="token punctuation">,</span> Entries<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>pb<span class="token punctuation">.</span>Entry<span class="token punctuation">{</span><span class="token punctuation">{</span>Data<span class="token punctuation">:</span> data<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">stepFollower</span><span class="token punctuation">(</span>r <span class="token operator">*</span>raft<span class="token punctuation">,</span> m pb<span class="token punctuation">.</span>Message<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> m<span class="token punctuation">.</span>Type <span class="token punctuation">{</span>
	<span class="token keyword">case</span> pb<span class="token punctuation">.</span>MsgProp<span class="token punctuation">:</span>
		<span class="token keyword">if</span> r<span class="token punctuation">.</span>lead <span class="token operator">==</span> None <span class="token punctuation">{</span>
			r<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;%x no leader at term %d; dropping proposal&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>id<span class="token punctuation">,</span> r<span class="token punctuation">.</span>Term<span class="token punctuation">)</span>
			<span class="token keyword">return</span> ErrProposalDropped
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> r<span class="token punctuation">.</span>disableProposalForwarding <span class="token punctuation">{</span>
			r<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">&quot;%x not forwarding to leader %x at term %d; dropping proposal&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>id<span class="token punctuation">,</span> r<span class="token punctuation">.</span>lead<span class="token punctuation">,</span> r<span class="token punctuation">.</span>Term<span class="token punctuation">)</span>
			<span class="token keyword">return</span> ErrProposalDropped
		<span class="token punctuation">}</span>
		<span class="token comment">// 设置发送的目标为leader</span>
		<span class="token comment">// 将信息发送给leader</span>
		m<span class="token punctuation">.</span>To <span class="token operator">=</span> r<span class="token punctuation">.</span>lead
		r<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>(2) leader收到Message以后，会处理Message中的日志条目，将其append到raftLog的unstable的日志中，并且调用bcastAppend()广播append日志的消息。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">stepLeader</span><span class="token punctuation">(</span>r <span class="token operator">*</span>raft<span class="token punctuation">,</span> m pb<span class="token punctuation">.</span>Message<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token comment">// These message types do not require any progress for m.From.</span>
	<span class="token keyword">switch</span> m<span class="token punctuation">.</span>Type <span class="token punctuation">{</span>
		<span class="token operator">...</span>
	<span class="token keyword">case</span> pb<span class="token punctuation">.</span>MsgProp<span class="token punctuation">:</span>
		<span class="token operator">...</span>
		<span class="token comment">// 将Entry记录追加到当前节点的raftlog中</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>r<span class="token punctuation">.</span><span class="token function">appendEntry</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Entries<span class="token operator">...</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> ErrProposalDropped
		<span class="token punctuation">}</span>
		<span class="token comment">// 向其他节点复制Entry记录</span>
		r<span class="token punctuation">.</span><span class="token function">bcastAppend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token operator">...</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>raft<span class="token punctuation">)</span> <span class="token function">maybeSendAppend</span><span class="token punctuation">(</span>to <span class="token builtin">uint64</span><span class="token punctuation">,</span> sendIfEmpty <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	pr <span class="token operator">:=</span> r<span class="token punctuation">.</span>prs<span class="token punctuation">.</span>Progress<span class="token punctuation">[</span>to<span class="token punctuation">]</span>
	<span class="token keyword">if</span> pr<span class="token punctuation">.</span><span class="token function">IsPaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>
	m <span class="token operator">:=</span> pb<span class="token punctuation">.</span>Message<span class="token punctuation">{</span><span class="token punctuation">}</span>
	m<span class="token punctuation">.</span>To <span class="token operator">=</span> to
	<span class="token operator">...</span>
	m<span class="token punctuation">.</span>Type <span class="token operator">=</span> pb<span class="token punctuation">.</span>MsgApp
	m<span class="token punctuation">.</span>Index <span class="token operator">=</span> pr<span class="token punctuation">.</span>Next <span class="token operator">-</span> <span class="token number">1</span>
	m<span class="token punctuation">.</span>LogTerm <span class="token operator">=</span> term
	m<span class="token punctuation">.</span>Entries <span class="token operator">=</span> ents
	m<span class="token punctuation">.</span>Commit <span class="token operator">=</span> r<span class="token punctuation">.</span>raftLog<span class="token punctuation">.</span>committed
	<span class="token keyword">if</span> n <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Entries<span class="token punctuation">)</span><span class="token punctuation">;</span> n <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">switch</span> pr<span class="token punctuation">.</span>State <span class="token punctuation">{</span>
		<span class="token comment">// optimistically increase the next when in StateReplicate</span>
		<span class="token keyword">case</span> tracker<span class="token punctuation">.</span>StateReplicate<span class="token punctuation">:</span>
			last <span class="token operator">:=</span> m<span class="token punctuation">.</span>Entries<span class="token punctuation">[</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Index
			pr<span class="token punctuation">.</span><span class="token function">OptimisticUpdate</span><span class="token punctuation">(</span>last<span class="token punctuation">)</span>
			pr<span class="token punctuation">.</span>Inflights<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>last<span class="token punctuation">)</span>
		<span class="token keyword">case</span> tracker<span class="token punctuation">.</span>StateProbe<span class="token punctuation">:</span>
			pr<span class="token punctuation">.</span>ProbeSent <span class="token operator">=</span> <span class="token boolean">true</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			r<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">Panicf</span><span class="token punctuation">(</span><span class="token string">&quot;%x is sending append in unhandled state %s&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>id<span class="token punctuation">,</span> pr<span class="token punctuation">.</span>State<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	r<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p>(3) leader中的消息最终会以MsgApp类型的消息通知follower，follower收到这些信息之后，同leader一样，先将缓存中的日志条目持久化到磁盘中并将当前已经持久化的最新日志index返回给leader。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">stepFollower</span><span class="token punctuation">(</span>r <span class="token operator">*</span>raft<span class="token punctuation">,</span> m pb<span class="token punctuation">.</span>Message<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> m<span class="token punctuation">.</span>Type <span class="token punctuation">{</span>
	<span class="token keyword">case</span> pb<span class="token punctuation">.</span>MsgApp<span class="token punctuation">:</span>
		r<span class="token punctuation">.</span>electionElapsed <span class="token operator">=</span> <span class="token number">0</span>
		r<span class="token punctuation">.</span>lead <span class="token operator">=</span> m<span class="token punctuation">.</span>From
		r<span class="token punctuation">.</span><span class="token function">handleAppendEntries</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>raft<span class="token punctuation">)</span> <span class="token function">handleAppendEntries</span><span class="token punctuation">(</span>m pb<span class="token punctuation">.</span>Message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span><span class="token punctuation">.</span>
	<span class="token keyword">if</span> mlastIndex<span class="token punctuation">,</span> ok <span class="token operator">:=</span> r<span class="token punctuation">.</span>raftLog<span class="token punctuation">.</span><span class="token function">maybeAppend</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>Index<span class="token punctuation">,</span> m<span class="token punctuation">.</span>LogTerm<span class="token punctuation">,</span> m<span class="token punctuation">.</span>Commit<span class="token punctuation">,</span> m<span class="token punctuation">.</span>Entries<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		r<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>pb<span class="token punctuation">.</span>Message<span class="token punctuation">{</span>To<span class="token punctuation">:</span> m<span class="token punctuation">.</span>From<span class="token punctuation">,</span> Type<span class="token punctuation">:</span> pb<span class="token punctuation">.</span>MsgAppResp<span class="token punctuation">,</span> Index<span class="token punctuation">:</span> mlastIndex<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token operator">...</span>
<span class="token punctuation">}</span>
<span class="token comment">// maybeAppend returns (0, false) if the entries cannot be appended. Otherwise,</span>
<span class="token comment">// it returns (last index of new entries, true).</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>raftLog<span class="token punctuation">)</span> <span class="token function">maybeAppend</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> logTerm<span class="token punctuation">,</span> committed <span class="token builtin">uint64</span><span class="token punctuation">,</span> ents <span class="token operator">...</span>pb<span class="token punctuation">.</span>Entry<span class="token punctuation">)</span> <span class="token punctuation">(</span>lastnewi <span class="token builtin">uint64</span><span class="token punctuation">,</span> ok <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	l<span class="token punctuation">.</span><span class="token function">commitTo</span><span class="token punctuation">(</span><span class="token function">min</span><span class="token punctuation">(</span>committed<span class="token punctuation">,</span> lastnewi<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token operator">...</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>raftLog<span class="token punctuation">)</span> <span class="token function">commitTo</span><span class="token punctuation">(</span>tocommit <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// never decrease commit</span>
	<span class="token keyword">if</span> l<span class="token punctuation">.</span>committed <span class="token operator">&lt;</span> tocommit <span class="token punctuation">{</span>
		<span class="token keyword">if</span> l<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> tocommit <span class="token punctuation">{</span>
			l<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">Panicf</span><span class="token punctuation">(</span><span class="token string">&quot;tocommit(%d) is out of range [lastIndex(%d)]. Was the raft log corrupted, truncated, or lost?&quot;</span><span class="token punctuation">,</span> tocommit<span class="token punctuation">,</span> l<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		l<span class="token punctuation">.</span>committed <span class="token operator">=</span> tocommit
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>(4) 最后leader收到大多数的follower的确认，commit自己的log，同时再次广播通知follower自己已经提交了。</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">stepLeader</span><span class="token punctuation">(</span>r <span class="token operator">*</span>raft<span class="token punctuation">,</span> m pb<span class="token punctuation">.</span>Message<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token comment">// These message types do not require any progress for m.From.</span>
	<span class="token keyword">switch</span> m<span class="token punctuation">.</span>Type <span class="token punctuation">{</span>
		<span class="token operator">...</span>
	<span class="token keyword">case</span> pb<span class="token punctuation">.</span>MsgAppResp<span class="token punctuation">:</span>
		pr<span class="token punctuation">.</span>RecentActive <span class="token operator">=</span> <span class="token boolean">true</span>
		<span class="token keyword">if</span> r<span class="token punctuation">.</span><span class="token function">maybeCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">releasePendingReadIndexMessages</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
			<span class="token comment">// 如果可以commit日志，那么广播append消息</span>
			r<span class="token punctuation">.</span><span class="token function">bcastAppend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> oldPaused <span class="token punctuation">{</span>
			<span class="token comment">// 如果该节点之前状态是暂停，继续发送append消息给它</span>
			r<span class="token punctuation">.</span><span class="token function">sendAppend</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>From<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token operator">...</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span class="token comment">// 尝试提交索引，如果已经提交返回true</span>
<span class="token comment">// 然后应该调用bcastAppend通知所有的follower</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>raft<span class="token punctuation">)</span> <span class="token function">maybeCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	mci <span class="token operator">:=</span> r<span class="token punctuation">.</span>prs<span class="token punctuation">.</span><span class="token function">Committed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> r<span class="token punctuation">.</span>raftLog<span class="token punctuation">.</span><span class="token function">maybeCommit</span><span class="token punctuation">(</span>mci<span class="token punctuation">,</span> r<span class="token punctuation">.</span>Term<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 提交修改committed就可以了</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>l <span class="token operator">*</span>raftLog<span class="token punctuation">)</span> <span class="token function">commitTo</span><span class="token punctuation">(</span>tocommit <span class="token builtin">uint64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// never decrease commit</span>
	<span class="token keyword">if</span> l<span class="token punctuation">.</span>committed <span class="token operator">&lt;</span> tocommit <span class="token punctuation">{</span>
		<span class="token keyword">if</span> l<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> tocommit <span class="token punctuation">{</span>
			l<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">Panicf</span><span class="token punctuation">(</span><span class="token string">&quot;tocommit(%d) is out of range [lastIndex(%d)]. Was the raft log corrupted, truncated, or lost?&quot;</span><span class="token punctuation">,</span> tocommit<span class="token punctuation">,</span> l<span class="token punctuation">.</span><span class="token function">lastIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		l<span class="token punctuation">.</span>committed <span class="token operator">=</span> tocommit
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h2 id="四、总结与感悟"><a href="#四、总结与感悟" class="header-anchor">#</a> 四、总结与感悟</h2> <p>综上所述，etcd的源码分析分析在此告一段落，总的来说本次的源码分析过程对于我来说受益匪浅，通过现象看本质，从刚开始的功能介绍及应用场景为切入点，主要是回答了是什么和怎么用的话题，后续从组成模型及源码介绍出发，深入浅出的回答了为什么的话题。</p> <p>每一个云原生开源项目的出现，都针对实实在在的问题与痛点，就如天上飞的理念，落地的实现，接口与实现类的关系。就我个人而言，起初从简单理解Raft算法过程，到如今慢慢理解Raft算法如何在真实场景的应用。虽然阅读源码很难，但我自己也渐渐积累了源码阅读的方法论，总的来说有提升也有所获。</p> <p>源码不易，开源有意，希望我以这门课为起点，在后续的学习和开发过程中，积极参与到社区的大家庭中，贡献自己的一份力量。</p></div></article> <section class="post-meta main-div" data-v-cae733bc><section class="post-date clearfix" data-v-cae733bc><span class="create-date" data-v-cae733bc>
        Created : 2022-11-12
      </span> <!----> <br data-v-cae733bc></section> <section class="post-links" data-v-cae733bc><a href="/posts/2022/04/06/mit6-824-2020-lab2a-leader-election-and-heartbeat.html" class="post-link" data-v-cae733bc>
        Previous Post : MIT6.824-2020 Lab2A Leader Election and heartbeat
      </a> <a href="/posts/2023/02/19/mvcc.html" class="post-link" data-v-cae733bc>
        Next Post : Mysql原理——多版本并发控制
      </a></section></section> <div id="post-comments" class="main-div"><!----></div></div></main> <aside class="aside" data-v-41e4f7f8><div class="info-card main-div" data-v-1732e38d data-v-41e4f7f8><div class="info-card-header" data-v-1732e38d><img src="/assets/img/Abyss.jpg" alt="Abyss Wang" class="info-avatar" data-v-1732e38d></div> <div class="info-card-body" data-v-1732e38d><section class="info-nickname" data-v-1732e38d>
      Abyss Wang
    </section> <section class="info-desc" data-v-1732e38d>Happy Coding<br/>Happy Life</section> <section class="info-contact" data-v-1732e38d><section data-v-1732e38d><span title="Hangzhou, China" data-v-1732e38d data-v-1732e38d><svg class="icon" style="font-size:1em;" data-v-1732e38d data-v-1732e38d><title data-v-1732e38d data-v-1732e38d>Hangzhou, China</title><use xlink:href="#icon-location" data-v-1732e38d data-v-1732e38d></use></svg><span class="info-text" data-v-1732e38d data-v-1732e38d>
          Hangzhou, China
        </span></span></section> <section data-v-1732e38d><span title="ZJUT/ZJU" data-v-1732e38d data-v-1732e38d><svg class="icon" style="font-size:1em;" data-v-1732e38d data-v-1732e38d><title data-v-1732e38d data-v-1732e38d>ZJUT/ZJU</title><use xlink:href="#icon-organization" data-v-1732e38d data-v-1732e38d></use></svg><span class="info-text" data-v-1732e38d data-v-1732e38d>
          ZJUT/ZJU
        </span></span></section> <section data-v-1732e38d><a href="mailto:wxuanye@yeah.net" title="wxuanye@yeah.net" data-v-1732e38d data-v-1732e38d><svg class="icon" style="font-size:1em;" data-v-1732e38d data-v-1732e38d><title data-v-1732e38d data-v-1732e38d>wxuanye@yeah.net</title><use xlink:href="#icon-email" data-v-1732e38d data-v-1732e38d></use></svg><span class="info-text" data-v-1732e38d data-v-1732e38d>
          wxuanye@yeah.net
        </span></a></section></section></div> <div class="info-card-footer" data-v-1732e38d><section class="info-sns clearfix" data-v-1732e38d><a href="https://github.com/wangxye" target="_blank" class="sns-link" data-v-1732e38d><span title="GitHub: wangxye" class="sns-icon" data-v-1732e38d data-v-1732e38d><svg class="icon" style="font-size:1.5em;" data-v-1732e38d data-v-1732e38d><title data-v-1732e38d data-v-1732e38d>GitHub: wangxye</title><use xlink:href="#icon-github" data-v-1732e38d data-v-1732e38d></use></svg></span></a><a href="https://www.zhihu.com/people/black-panther-34" target="_blank" class="sns-link" data-v-1732e38d><span title="知乎: Abyss" class="sns-icon" data-v-1732e38d data-v-1732e38d><svg class="icon" style="font-size:1.5em;" data-v-1732e38d data-v-1732e38d><title data-v-1732e38d data-v-1732e38d>知乎: Abyss</title><use xlink:href="#icon-zhihu" data-v-1732e38d data-v-1732e38d></use></svg></span></a><a href="https://www.csdn.net/" target="_blank" class="sns-link" data-v-1732e38d><span title="CSDN: " class="sns-icon" data-v-1732e38d data-v-1732e38d><svg class="icon" style="font-size:1.5em;" data-v-1732e38d data-v-1732e38d><title data-v-1732e38d data-v-1732e38d>CSDN: </title><use xlink:href="#icon-csdn" data-v-1732e38d data-v-1732e38d></use></svg></span></a></section></div></div> <div class="post-nav-card main-div" style="position:relative;top:0;width:0px;" data-v-41e4f7f8><div class="post-nav-contents"><svg class="icon"><title>book</title><use xlink:href="#icon-book"></use></svg> <span>Table of Contents</span> <div class="post-nav-toc"><ul><li><a href="/posts/2022/11/12/etcd-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html#一、etcd概述">一、etcd概述</a><ul><li><a href="/posts/2022/11/12/etcd-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html#_1-1-etcd是什么">1.1 etcd是什么</a></li><li><a href="/posts/2022/11/12/etcd-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html#_1-2-应用场景">1.2 应用场景</a></li><li><a href="/posts/2022/11/12/etcd-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html#_1-3-常用术语">1.3 常用术语</a></li></ul></li><li><a href="/posts/2022/11/12/etcd-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html#二、etcd组成模型">二、etcd组成模型</a><ul><li><a href="/posts/2022/11/12/etcd-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html#_2-1-服务器状态">2.1 服务器状态</a></li><li><a href="/posts/2022/11/12/etcd-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html#_2-2-核心架构">2.2 核心架构</a></li><li><a href="/posts/2022/11/12/etcd-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html#_2-3-读写总体概述">2.3 读写总体概述</a></li></ul></li><li><a href="/posts/2022/11/12/etcd-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html#三、源码分析">三、源码分析</a><ul><li><a href="/posts/2022/11/12/etcd-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html#_3-1-源码结构及功能">3.1 源码结构及功能</a></li><li><a href="/posts/2022/11/12/etcd-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html#_3-2-客户端设计">3.2 客户端设计</a></li><li><a href="/posts/2022/11/12/etcd-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html#_3-3-api-接口层设计">3.3 API 接口层设计</a></li><li><a href="/posts/2022/11/12/etcd-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html#_3-4-服务端设计">3.4 服务端设计</a></li><li><a href="/posts/2022/11/12/etcd-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html#_3-5-raft设计">3.5 Raft设计</a></li></ul></li><li><a href="/posts/2022/11/12/etcd-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html#四、总结与感悟">四、总结与感悟</a></li></ul></div></div> <div class="post-nav-comments"><svg class="icon"><title>comment</title><use xlink:href="#icon-comment"></use></svg> <a href="/posts/2022/11/12/etcd-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html#post-comments">
      Comments
    </a></div></div></aside></div> <footer class="footer" data-v-24c54b5c><p class="footer-sns-links" data-v-24c54b5c><a href="https://github.com/wangxye" target="_blank" class="sns-link" data-v-24c54b5c><span title="GitHub: wangxye" class="sns-icon" data-v-24c54b5c data-v-24c54b5c><svg class="icon" style="font-size:25px;" data-v-24c54b5c data-v-24c54b5c><title data-v-24c54b5c data-v-24c54b5c>GitHub: wangxye</title><use xlink:href="#icon-github" data-v-24c54b5c data-v-24c54b5c></use></svg></span></a><a href="https://www.zhihu.com/people/black-panther-34" target="_blank" class="sns-link" data-v-24c54b5c><span title="知乎: Abyss" class="sns-icon" data-v-24c54b5c data-v-24c54b5c><svg class="icon" style="font-size:25px;" data-v-24c54b5c data-v-24c54b5c><title data-v-24c54b5c data-v-24c54b5c>知乎: Abyss</title><use xlink:href="#icon-zhihu" data-v-24c54b5c data-v-24c54b5c></use></svg></span></a><a href="https://www.csdn.net/" target="_blank" class="sns-link" data-v-24c54b5c><span title="CSDN: " class="sns-icon" data-v-24c54b5c data-v-24c54b5c><svg class="icon" style="font-size:25px;" data-v-24c54b5c data-v-24c54b5c><title data-v-24c54b5c data-v-24c54b5c>CSDN: </title><use xlink:href="#icon-csdn" data-v-24c54b5c data-v-24c54b5c></use></svg></span></a></p> <div class="busuanzi" data-v-24c54b5c><span id="busuanzi_container_site_pv" style="display:none" data-v-24c54b5c>
    本站总访问量
    <span id="busuanzi_value_site_pv" data-v-24c54b5c></span>次
    <span class="post-meta-divider" data-v-24c54b5c>|</span></span> <span id="busuanzi_container_site_uv" style="display:none" data-v-24c54b5c>
    本站访客数
    <span id="busuanzi_value_site_uv" data-v-24c54b5c></span>人
  </span></div> <p class="footer-text" data-v-24c54b5c>Copyright 2021-present <a href="https://github.com/wangxye" target="_blank">wangxye</a> | MIT License</p></footer></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/vendor.vue.8c2dfada.js" defer></script><script src="/assets/js/8.49c1931d.js" defer></script><script src="/assets/js/35.21e5fed2.js" defer></script><script src="/assets/js/vendor.commons.6d048c9e.js" defer></script><script src="/assets/js/app.33c1ef9e.js" defer></script>
  </body>
</html>
